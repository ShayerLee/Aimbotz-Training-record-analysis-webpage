<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Aimbotz训练数据记录与分析（本地版）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: 'Microsoft YaHei', Arial, sans-serif; margin: 0; padding: 0; background: #f4f8fb; }
    .top-bg { width: 100%; height: 320px; background: linear-gradient(135deg, #2196f3 60%, #1565c0 100%); background-image: url('image/bg.png'), url('image/bg.jpg'); background-size: cover; background-position: center; position: absolute; top: 0; left: 0; z-index: 0; filter: brightness(0.7) saturate(1.2); }
    .container { max-width: 1200px; margin: 0 auto; background: #fff; border-radius: 12px; box-shadow: 0 4px 24px #1565c033; padding: 36px 32px 32px 32px; position: relative; z-index: 1; margin-top: 160px; }
    h1 { text-align: center; margin-bottom: 28px; color: #1565c0; letter-spacing: 2px; font-weight: 700; font-size: 2.2rem; text-shadow: 0 2px 8px #2196f355; }
    .input-row, .view-row { display: flex; gap: 14px; align-items: center; margin-bottom: 22px; justify-content: center; }
    .input-row { gap:24px; justify-content:center; align-items:stretch; flex-wrap:wrap; }
    .input-row textarea { resize:vertical; max-width:600px; width:100%; font-size:16px; padding:10px 14px; border:1.5px solid #2196f3; border-radius:6px; background:#f4f8fb; height:100%; min-height:160px; box-sizing:border-box; }
    .data-section { display: flex; gap: 36px; align-items: flex-start; margin-top: 18px; flex-wrap: wrap; box-sizing: border-box; }
    .data-table { overflow-x: auto; max-height: 420px; border-radius: 8px; border: 1.5px solid #e3f2fd; background: #fafdff; box-shadow: 0 2px 8px #2196f322; }
    table { border-collapse: collapse; min-width: 650px; width: 100%; font-size: 15px; background: #fafdff; }
    th, td { padding: 10px 14px; border-bottom: 1px solid #e3f2fd; text-align: center; }
    th { background: #e3f2fd; color: #1565c0; font-weight: 600; position: sticky; top: 0; z-index: 1; font-size: 16px; }
    tr:last-child td { border-bottom: none; }
    .charts { display: grid; grid-template-columns: 1fr 1fr; gap: 28px 24px; min-width: 0; width: 100%; box-sizing: border-box; max-width: 100%; }
    .chart-container { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #2196f322; padding: 18px 12px 8px 12px; border: 1.5px solid #e3f2fd; display: flex; flex-direction: column; align-items: center; box-sizing: border-box; max-width: 100%; min-width: 0; }
    .chart-title { font-size: 16px; color: #1565c0; font-weight: 600; margin-bottom: 4px; letter-spacing: 1px; text-align: center; }
    .chart-best { font-size: 14px; color: #1565c0; text-align: center; margin-top: 6px; }
    .chart-best span { color: #e53935; font-weight: 700; }
    .chart-best span.congrats {
      display: inline-block;
      animation: congrats-scale 1.2s infinite cubic-bezier(.4,1.6,.4,1);
    }
    @keyframes congrats-scale {
      0% { transform: scale(1); }
      30% { transform: scale(1.25); }
      60% { transform: scale(0.95); }
      100% { transform: scale(1); }
    }
    @media (max-width: 900px) { .data-section { flex-direction: column; } .charts { grid-template-columns: 1fr; min-width: 0; } .container { padding: 12px 2vw 12px 2vw; margin-top: 80px; } }
    @media (max-width: 600px) { .container { padding: 4px 1vw 4px 1vw; } .charts { gap: 8px; } .chart-container { padding: 4px 1px 2px 1px; } table { min-width: 320px; font-size: 13px; } th, td { padding: 6px 4px; } .data-table { max-height: 220px; } }
    td[data-tooltip]::after { content: attr(data-tooltip); position: absolute; left: 50%; top: 100%; transform: translateX(-50%); background: #1565c0; color: #fff; font-size: 13px; padding: 4px 10px; border-radius: 6px; white-space: nowrap; z-index: 1002; margin-top: 4px; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
    td.show-tooltip[data-tooltip]::after { opacity: 1; }
    td { position: relative; }
    body.night, .night .container, .night .top-bg {
      background: #181c24 !important;
      color: #e3e6ef !important;
    }
    body.night .container {
      background: #23283a !important;
      color: #e3e6ef !important;
    }
    body.night .top-bg {
      background: linear-gradient(120deg,#23283a 0%,#181c24 100%) !important;
      opacity: 0.95 !important;
    }
    body.night .input-row textarea,
    body.night select,
    body.night input[type="datetime-local"] {
      background: #23283a !important;
      color: #e3e6ef !important;
      border-color: #3a4a6a !important;
    }
    body.night button {
      background: #23283a !important;
      color: #90caf9 !important;
      border-color: #3a4a6a !important;
    }
    body.night th, body.night td {
      background: #23283a !important;
      color: #e3e6ef !important;
    }
    body.night .chart-best span.congrats {
      color: #ff5252 !important;
    }
    body.night #saveTip {
      background: #1565c0 !important;
      color: #fff !important;
    }
    body.night .data-ops button {
      background: #23283a !important;
      color: #90caf9 !important;
      border-color: #3a4a6a !important;
    }
    body.night .data-ops button:hover {
      background: #1e2230 !important;
    }
    body.night .ad-box {
      background: #23283a !important;
      border-color: #3a4a6a !important;
    }
    body.night .modal, body.night #manualModal, body.night #editModal {
      background: #23283a !important;
      color: #e3e6ef !important;
    }
    body.night .modal input, body.night .modal textarea {
      background: #181c24 !important;
      color: #e3e6ef !important;
      border-color: #3a4a6a !important;
    }
    body.night .modal button {
      background: #23283a !important;
      color: #90caf9 !important;
      border-color: #3a4a6a !important;
    }
    body.night .modal button:hover {
      background: #1e2230 !important;
    }
    .blue-btn {
      background: #2196f3;
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 8px 22px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 8px #2196f355;
      transition: background 0.2s, box-shadow 0.2s;
      margin-right: 2px;
    }
    .blue-btn:hover, .blue-btn:focus {
      background: #1565c0;
      box-shadow: 0 4px 16px #2196f366;
    }
    .red-btn {
      background: #f44336;
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 8px 22px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 8px #f4433655;
      transition: background 0.2s, box-shadow 0.2s;
      margin-right: 2px;
    }
    .red-btn:hover, .red-btn:focus {
      background: #b71c1c;
      box-shadow: 0 4px 16px #f4433666;
    }
    select:focus {
      border-color: #1565c0 !important;
      box-shadow: 0 0 0 2px #2196f355 !important;
    }
    @media (max-width: 600px) {
      .blue-btn, .red-btn {
        padding: 8px 10px;
        font-size: 14px;
      }
      select {
        font-size: 14px !important;
      }
    }
    .menu-dialog-box {
      border: 2.5px solid #2196f3;
      box-shadow: 0 4px 24px #2196f355, 0 1.5px 8px #1565c055;
      animation: menudialog-pop 0.22s cubic-bezier(.4,1.6,.4,1);
    }
    @keyframes menudialog-pop {
      0% { transform: scale(0.85); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
    .menu-dialog-box button.blue-btn, .menu-dialog-box button.red-btn {
      margin-bottom: 0;
      margin-top: 0;
    }
    .menu-dialog-box h3 {
      font-weight: 700;
      letter-spacing: 1px;
    }
    /* 统计面板样式 */
    .stats-card { background: #e3f2fd; border-radius: 14px; box-shadow: 0 2px 12px #2196f344; padding: 18px 24px; justify-content: center; }
    .night .stats-card { background: #23283a; box-shadow: 0 2px 12px #1565c044; }
    .stats-item { min-width: 120px; margin-right: 8px; }
    .stats-label { font-size: 14px; color: #1565c0; font-weight: 600; margin-bottom: 2px; }
    .night .stats-label { color: #90caf9; }
    .stats-value { font-size: 18px; font-weight: bold; color: #1976d2; }
    .night .stats-value { color: #90caf9; }
    .stats-sub { font-size: 12px; color: #888; margin-left: 2px; }
    @media (max-width: 600px) { .stats-card { flex-direction: column; gap: 10px; padding: 12px 6px; align-items: center; } .stats-item { min-width: 90px; } }
    @media (max-width: 900px) {
      #sideOps { max-width: 100vw !important; min-width: 0 !important; }
      #sideOps .data-ops { flex-direction: row !important; flex-wrap: wrap; gap: 10px !important; }
      #sideOps button, #sideOps select { width: 100%; min-width: 0; }
    }
    @media (max-width: 600px) {
      #sideOps { flex-direction: row !important; gap: 8px !important; }
      #sideOps .data-ops { flex-direction: column !important; gap: 8px !important; }
      #sideOps button, #sideOps select { font-size: 14px !important; padding: 8px 10px !important; }
    }
    @media (max-width: 1200px) {
      .table-wrap table { min-width: 700px !important; }
    }
    @media (max-width: 900px) {
      .table-wrap table { min-width: 520px !important; }
    }
    @media (max-width: 600px) {
      .table-wrap table { min-width: 320px !important; }
    }
    .small-btn {
      font-size: 13px !important;
      padding: 5px 12px !important;
      border-radius: 6px !important;
      min-width: 0 !important;
      width: 100%;
      max-width: 140px;
      height: 32px;
    }
    #sideOps .data-ops { gap: 8px !important; }
    #sideOps select { max-width: 140px !important; font-size: 13px !important; padding: 4px 10px !important; height: 32px; }
    @media (max-width: 900px) {
      .small-btn { max-width: 100vw !important; }
      #sideOps select { max-width: 100vw !important; }
    }
    @media (max-width: 600px) {
      .small-btn { font-size: 12px !important; padding: 4px 6px !important; height: 28px; }
      #sideOps select { font-size: 12px !important; padding: 3px 6px !important; height: 28px; }
    }
    .main-flex-wrap {
      display: flex;
      gap: 36px;
      align-items: flex-start;
      justify-content: center;
      margin: 0 auto 0 auto;
      max-width: 1800px;
      width: 100%;
    }
    .main-table-wrap {
      flex: 3;
      min-width: 520px;
      max-width: 1400px;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      justify-content: flex-start;
    }
    .side-ops-panel {
      flex: 1;
      min-width: 180px;
      max-width: 180px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: flex-start;
      margin-top: 0;
      padding-top: 8px;
      gap: 0;
    }
    @media (max-width: 1200px) {
      .main-flex-wrap { gap: 18px; }
      .main-table-wrap { min-width: 340px; }
      .side-ops-panel { max-width: 140px; min-width: 120px; }
    }
    @media (max-width: 900px) {
      .main-flex-wrap { flex-direction: column; align-items: stretch; gap: 10px; }
      .main-table-wrap { align-items: stretch; }
      .side-ops-panel { flex-direction: row; max-width: 100vw; min-width: 0; align-items: flex-start; gap: 10px; padding-top: 0; }
      .side-ops-panel > div { flex: 1; }
    }
    @media (max-width: 600px) {
      .main-flex-wrap { gap: 4px; }
      .main-table-wrap { min-width: 0; }
      .side-ops-panel { flex-direction: column; max-width: 100vw; min-width: 0; gap: 6px; }
    }
    .float-nav-btn {
      position: fixed;
      right: 28px;
      bottom: 36px;
      z-index: 3003;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #2196f3;
      color: #fff;
      font-size: 26px;
      box-shadow: 0 2px 12px #2196f355;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s, box-shadow 0.2s, transform 0.15s;
      opacity: 0.92;
    }
    .float-nav-btn:hover { background: #1565c0; box-shadow: 0 4px 18px #2196f366; transform: scale(1.08); }
    .night .float-nav-btn { background: #1565c0; color: #fff; }
    @media (max-width: 600px) {
      .float-nav-btn { width: 38px; height: 38px; font-size: 20px; right: 12px; bottom: 18px; }
      #gotoChartsBtn { bottom: 62px !important; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div style="position:fixed;top:18px;left:18px;z-index:2001;display:flex;gap:12px;align-items:center;">
    <select id="langSelect" style="padding:4px 10px;border-radius:6px;border:1.5px solid #2196f3;font-size:15px;">
      <option value="zh">简体中文</option>
      <option value="en">English</option>
    </select>
    <button id="themeToggleBtn" style="padding:4px 14px;border-radius:6px;border:1.5px solid #2196f3;font-size:15px;background:#fff;color:#1565c0;cursor:pointer;">夜间模式</button>
  </div>
  <div class="top-bg"></div>
  <div class="container" id="mainApp">
    <h1>Aimbotz训练数据记录与分析（本地版）</h1>
    <div class="input-row">
      <div style="flex:2;min-width:260px;max-width:600px;display:flex;align-items:stretch;">
        <textarea id="dataInput" placeholder="请输入训练结果文本，回车录入..." rows="8"></textarea>
      </div>
      <div style="flex:1;min-width:180px;max-width:260px;display:flex;flex-direction:column;justify-content:space-between;align-items:stretch;">
        <div style="display:flex;flex-direction:column;gap:18px;justify-content:space-between;height:100%;">
          <div style="display:flex;flex-direction:column;gap:8px;">
            <label style="margin-bottom:2px;font-size:15px;color:#1565c0;font-weight:600;">训练项目</label>
            <div style="display:flex;gap:8px;align-items:center;">
              <select id="tableSelect" style="flex:1;padding:7px 18px;border-radius:7px;border:1.5px solid #2196f3;font-size:15px;background:#f4f8fb;color:#1565c0;box-shadow:0 1px 6px #2196f322;outline:none;transition:border 0.2s;"></select>
              <button id="addTableBtn" style="padding:7px 12px;background:#4caf50;color:#fff;border:none;border-radius:7px;font-size:14px;cursor:pointer;box-shadow:0 1px 6px #4caf5055;transition:background 0.2s;white-space:nowrap;" title="新建项目">➕</button>
            </div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px;">
            <label style="margin-bottom:2px;font-size:15px;color:#1565c0;font-weight:600;">训练时间</label>
            <div style="display:flex;align-items:center;gap:6px;width:100%;">
              <select id="trainTimeType" style="flex:1;padding:7px 18px;border-radius:7px;border:1.5px solid #2196f3;font-size:15px;background:#f4f8fb;color:#1565c0;box-shadow:0 1px 6px #2196f322;outline:none;transition:border 0.2s;"><option value="now">当前时间</option><option value="custom">指定时间</option></select>
              <input id="customTrainTime" type="datetime-local" style="display:none;flex:2;" />
            </div>
          </div>
        </div>
        <div style="width:100%;display:flex;gap:10px;justify-content:center;margin-top:18px;">
          <button id="parseBtn" style="width:110px;background:#2196f3;color:#fff;border:none;border-radius:6px;padding:8px 0;font-size:15px;font-weight:600;cursor:pointer;box-shadow:0 2px 8px #2196f355;transition:background 0.2s;">识别数据</button>
          <button id="manualAddBtn" style="width:110px;background:#4caf50; color:#fff;border:none;border-radius:6px;padding:8px 0;font-size:15px;font-weight:600;cursor:pointer;box-shadow:0 2px 8px #4caf5055;transition:background 0.2s;">手动添加数据</button>
        </div>
      </div>
    </div>
    <div id="statsPanel" style="display:none;"></div>
    <div class="main-flex-wrap">
      <div class="main-table-wrap">
        <div id="dataSection" class="data-section" style="display:none;">
          <div class="table-wrap" style="overflow-x:auto;">
            <table id="dataTable" style="min-width:900px;width:100%;max-width:100%;border-collapse:collapse;">
              <thead id="tableHeader"></thead>
              <tbody id="tableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
      <div id="sideOps" class="side-ops-panel">
        <div style="display:flex;flex-direction:column;gap:10px;align-items:stretch;">
          <label for="viewSelect" style="font-size:15px;color:#1565c0;font-weight:600;">查看数据：</label>
          <select id="viewSelect" style="padding:4px 10px;border-radius:6px;border:1.2px solid #2196f3;font-size:13px;background:#f4f8fb;color:#1565c0;box-shadow:0 1px 4px #2196f322;outline:none;transition:border 0.2s;min-width:0;width:100%;max-width:140px;"></select>
        </div>
        <div class="data-ops" style="display:flex;flex-direction:column;gap:8px;align-items:stretch;margin-top:10px;">
          <button id="exportMenuBtn" class="blue-btn small-btn">导出</button>
          <button id="importMenuBtn" class="blue-btn small-btn">导入</button>
          <button id="exportCurrentBtn" style="display:none;">导出当前表格</button>
          <button id="exportAllBtn" style="display:none;">导出所有表格</button>
          <button id="importBtn" style="display:none;">导入数据</button>
          <button id="backupBtn" style="display:none;">备份数据</button>
          <button id="restoreBtn" style="display:none;">恢复数据</button>
          <button id="deleteAllBtn" class="red-btn small-btn">删除全部数据</button>
          <button id="deleteTableBtn" class="red-btn small-btn">删除项目</button>
        </div>
        <input type="file" id="importFile" accept=".xlsx" style="display:none;" />
      </div>
    </div>
    <div class="charts">
      <div class="chart-container"><div class="chart-title" id="chart-title-1"></div><canvas id="chart1"></canvas><div class="chart-best" id="chart-best-1"></div></div>
      <div class="chart-container"><div class="chart-title" id="chart-title-2"></div><canvas id="chart2"></canvas><div class="chart-best" id="chart-best-2"></div></div>
      <div class="chart-container"><div class="chart-title" id="chart-title-3"></div><canvas id="chart3"></canvas><div class="chart-best" id="chart-best-3"></div></div>
      <div class="chart-container"><div class="chart-title" id="chart-title-4"></div><canvas id="chart4"></canvas><div class="chart-best" id="chart-best-4"></div></div>
    </div>
  </div>
  <button id="feedbackBtn" style="position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#2196f3;color:#fff;border:none;border-radius:24px;padding:10px 32px;font-size:16px;font-weight:600;box-shadow:0 2px 8px #2196f355;cursor:pointer;z-index:1001;">意见反馈</button>
  <!-- 悬浮跳转按钮 -->
  <button id="gotoTableBtn" class="float-nav-btn" title="跳转到表格">📋</button>
  <button id="gotoChartsBtn" class="float-nav-btn" title="跳转到折线图" style="bottom:92px;">📈</button>
  <script>
    // 本地存储键
    const STORAGE_KEY = 'aimbotz_local_data_tables';
    // 表头定义
    const COLUMNS = [
      { key: 'trainTime', label: '训练时间' },
      { key: 'finishTime', label: '完成时间' },
      { key: 'killsPerMin', label: '每分钟击杀' },
      { key: 'killsPerSec', label: '每秒击杀' },
      { key: 'shotsPerKill', label: '准确率' }
    ];
    const CHARTS = [
      { key: 'finishTime', label: '完成时间', yLabel: '秒', parser: v => timeStrToSeconds(v) },
      { key: 'killsPerMin', label: '每分钟击杀', yLabel: '数值', parser: v => parseFloat(v) },
      { key: 'killsPerSec', label: '每秒击杀', yLabel: '数值', parser: v => parseFloat(v) },
      { key: 'shotsPerKill', label: '准确率', yLabel: '数值', parser: v => parseFloat(v) }
    ];

    // 本地存储操作
    function loadTables() {
      return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
    }
    function saveTables(tables) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(tables));
      showSaveTip();
    }

    // 工具函数
    function pad(n) { return n < 10 ? '0' + n : n; }
    function formatDate(dt) {
      return dt.getFullYear() + '-' + pad(dt.getMonth() + 1) + '-' + pad(dt.getDate()) + ' ' + pad(dt.getHours()) + ':' + pad(dt.getMinutes());
    }
    function formatDateLocal(dt) {
      return dt.getFullYear() + '-' + pad(dt.getMonth() + 1) + '-' + pad(dt.getDate()) + 'T' + pad(dt.getHours()) + ':' + pad(dt.getMinutes());
    }
    function timeStrToSeconds(str) {
      if (!str) return 0;
      let m = str.match(/(\d+):(\d+)(?:\.(\d+))?/);
      if (!m) return parseFloat(str) || 0;
      return parseInt(m[1]) * 60 + parseInt(m[2]) + (m[3] ? parseFloat('0.' + m[3]) : 0);
    }
    function secondsToTimeStr(sec) {
      let m = Math.floor(sec / 60), s = (sec % 60).toFixed(3);
      return pad(m) + ':' + pad(Math.floor(s)) + '.' + (s.split('.')[1] || '000');
    }

    // 全局变量
    let tables = loadTables();
    let currentTable = Object.keys(tables)[0] || '';
    let chartObjs = [];
    let lastTable = currentTable;

    // 语言包
    const LANGS = {
      zh: {
        title: 'Aimbotz训练数据记录与分析（本地版）',
        trainProject: '训练项目',
        trainTime: '训练时间',
        now: '当前时间',
        custom: '指定时间',
        recognize: '识别数据',
        manualAdd: '手动添加数据',
        viewData: '查看数据：',
        exportCurrent: '导出当前表格',
        exportAll: '导出所有表格',
        import: '导入数据',
        deleteAll: '删除全部数据',
        deleteTable: '删除项目',
        addTable: '➕ 新建项目',
        feedback: '意见反馈',
        feedbackMsg: '如有建议或问题，请联系开发者：shayer1688@163.com',
        confirmDeleteTable: '确定要删除当前训练项目及其所有数据吗？',
        confirmDeleteAll: '确定要删除当前表格的所有数据吗？',
        confirmDeleteRow: '确定要删除该条数据吗？',
        pleaseSelectTable: '请先选择训练项目',
        notRecognized: '未识别到有效数据！',
        inputTableName: '请输入新训练项目名称：',
        manualAddTitle: '手动添加数据',
        manualSave: '保存',
        manualCancel: '取消',
        editTitle: '修改数据',
        editSave: '保存',
        editCancel: '取消',
        bestShort: '历史最短',
        bestHigh: '历史最高',
        congrats: '恭喜！新纪录！',
        great: '干的漂亮！继续加油！',
        tryHard: '孩子，还需努力！',
        labels: ['训练时间','完成时间','每分钟击杀','每秒击杀','准确率'],
        chartTitles: ['完成时间','每分钟击杀','每秒击杀','准确率'],
        avgLine: '平均线',
        trendLine: '趋势线',
        edit: '修改',
        del: '删除',
        saveTip: '已保存',
        restoreSuccess: '恢复成功！',
        restoreFail: '恢复失败，文件格式不正确！',
        resetFilter: '重置筛选',
        filterSort: '筛选/排序',
        filterSortTitle: '筛选与排序',
        sortBy: '排序字段',
        asc: '升序',
        desc: '降序',
        apply: '应用',
        cancel: '取消',
        undo: '撤销',
        export: '导出',
        import: '导入',
        exportExcel: '导出Excel',
        exportJson: '导出JSON备份',
        importExcel: '导入Excel',
        importJson: '导入JSON备份',
        totalTrain: '训练次数',
        lastTrain: '最近训练',
      },
      en: {
        title: 'Aimbotz Training Data Tracker (Local)',
        trainProject: 'Project',
        trainTime: 'Train Time',
        now: 'Now',
        custom: 'Custom',
        recognize: 'Recognize',
        manualAdd: 'Manual Add',
        viewData: 'View:',
        exportCurrent: 'Export Current',
        exportAll: 'Export All',
        import: 'Import',
        deleteAll: 'Delete All',
        deleteTable: 'Delete Project',
        addTable: '➕ New Project',
        feedback: 'Feedback',
        feedbackMsg: 'For suggestions or issues, contact: shayer1688@163.com',
        confirmDeleteTable: 'Delete this project and all its data?',
        confirmDeleteAll: 'Delete all data in this table?',
        confirmDeleteRow: 'Delete this record?',
        pleaseSelectTable: 'Please select a project first',
        notRecognized: 'No valid data recognized!',
        inputTableName: 'Enter new project name:',
        manualAddTitle: 'Manual Add',
        manualSave: 'Save',
        manualCancel: 'Cancel',
        editTitle: 'Edit Data',
        editSave: 'Save',
        editCancel: 'Cancel',
        bestShort: 'Best (Shortest)',
        bestHigh: 'Best (Highest)',
        congrats: 'Congrats! New Record!',
        great: 'Great! Keep it up!',
        tryHard: 'Try harder!',
        labels: ['Train Time','Finish Time','Kills/Min','Kills/Sec','Accuracy'],
        chartTitles: ['Finish Time','Kills/Min','Kills/Sec','Accuracy'],
        avgLine: 'Avg',
        trendLine: 'Trend',
        edit: 'Edit',
        del: 'Delete',
        saveTip: 'Saved',
        restoreSuccess: 'Restore success!',
        restoreFail: 'Restore failed, invalid file!',
        resetFilter: 'Reset',
        filterSort: 'Filter/Sort',
        filterSortTitle: 'Filter & Sort',
        sortBy: 'Sort by',
        asc: 'Asc',
        desc: 'Desc',
        apply: 'Apply',
        cancel: 'Cancel',
        undo: 'Undo',
        export: 'Export',
        import: 'Import',
        exportExcel: 'Export Excel',
        exportJson: 'Export JSON',
        importExcel: 'Import Excel',
        importJson: 'Import JSON',
        totalTrain: 'Total',
        lastTrain: 'Last Train',
      }
    };
    let lang = localStorage.getItem('aimbotz_lang') || 'zh';
    function setLang(l) {
      lang = l;
      localStorage.setItem('aimbotz_lang', l);
      renderLang();
      renderTable();
    }
    document.getElementById('langSelect').value = lang;
    document.getElementById('langSelect').onchange = function() { setLang(this.value); };
    function renderLang() {
      const L = LANGS[lang];
      document.title = L.title;
      document.querySelector('h1').textContent = L.title;
      document.querySelector('label[for="viewSelect"]').textContent = L.viewData;
      document.getElementById('exportCurrentBtn').textContent = L.exportCurrent;
      document.getElementById('exportAllBtn').textContent = L.exportAll;
      document.getElementById('importBtn').textContent = L.import;
      document.getElementById('deleteAllBtn').textContent = L.deleteAll;
      document.getElementById('deleteTableBtn').textContent = L.deleteTable;
      document.getElementById('parseBtn').textContent = L.recognize;
      document.getElementById('manualAddBtn').textContent = L.manualAdd;
      document.getElementById('feedbackBtn').textContent = L.feedback;
      // 下拉菜单标题
      document.querySelectorAll('.input-row label')[0].textContent = L.trainProject;
      document.querySelectorAll('.input-row label')[1].textContent = L.trainTime;
      // 时间下拉
      let timeSel = document.getElementById('trainTimeType');
      timeSel.options[0].text = L.now;
      timeSel.options[1].text = L.custom;
    }

    // 初始化
    function refreshTableSelects() {
      const tableSelect = document.getElementById('tableSelect');
      const viewSelect = document.getElementById('viewSelect');
      const L = LANGS[lang];
      tableSelect.innerHTML = '';
      viewSelect.innerHTML = '';
      let hasTable = false;
      for (let name of Object.keys(tables)) {
        let opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        tableSelect.appendChild(opt);
        let opt2 = document.createElement('option');
        opt2.value = name;
        opt2.textContent = name;
        viewSelect.appendChild(opt2);
        hasTable = true;
      }
      // 如果没有项目，设置默认值
      if (!hasTable) {
        currentTable = '';
        tableSelect.value = '';
        viewSelect.value = '';
      } else {
        // 如果有项目，确保currentTable有效
        if (!currentTable || !(currentTable in tables)) {
          currentTable = Object.keys(tables)[0] || '';
        }
        tableSelect.value = currentTable;
        viewSelect.value = currentTable;
      }
      
      document.getElementById('dataSection').style.display = hasTable ? '' : 'none';
    }

    function showAddTableDialog() {
      console.log('showAddTableDialog called'); // 调试信息
      
      // 先移除可能存在的旧弹窗
      let oldModal = document.getElementById('addTableModal');
      if (oldModal) oldModal.remove();
      
      let L = LANGS[lang];
      
      // 创建模态框容器
      let modal = document.createElement('div');
      modal.id = 'addTableModal';
      modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;';
      
      // 创建弹窗内容
      let content = document.createElement('div');
      content.style.cssText = 'background:white;padding:30px;border-radius:10px;min-width:300px;max-width:90%;box-shadow:0 4px 20px rgba(0,0,0,0.3);';
      
      // 标题
      let title = document.createElement('h3');
      title.textContent = L.addTable;
      title.style.cssText = 'margin:0 0 20px 0;color:#1565c0;text-align:center;';
      content.appendChild(title);
      
      // 输入框
      let input = document.createElement('input');
      input.type = 'text';
      input.id = 'newTableName';
      input.placeholder = L.inputTableName;
      input.style.cssText = 'width:100%;padding:10px;border:2px solid #2196f3;border-radius:6px;font-size:16px;margin-bottom:20px;box-sizing:border-box;';
      content.appendChild(input);
      
      // 按钮容器
      let btnContainer = document.createElement('div');
      btnContainer.style.cssText = 'display:flex;gap:15px;justify-content:center;';
      
      // 确定按钮
      let saveBtn = document.createElement('button');
      saveBtn.textContent = '确定';
      saveBtn.style.cssText = 'background:#2196f3;color:white;padding:10px 20px;border:none;border-radius:6px;font-size:16px;cursor:pointer;';
      btnContainer.appendChild(saveBtn);
      
      // 取消按钮
      let cancelBtn = document.createElement('button');
      cancelBtn.textContent = '取消';
      cancelBtn.style.cssText = 'background:#ccc;color:#333;padding:10px 20px;border:none;border-radius:6px;font-size:16px;cursor:pointer;';
      btnContainer.appendChild(cancelBtn);
      
      content.appendChild(btnContainer);
      modal.appendChild(content);
      document.body.appendChild(modal);
      
      // 聚焦到输入框
      input.focus();
      
      // 事件处理
      cancelBtn.onclick = function() {
        modal.remove();
      };
      
      saveBtn.onclick = function() {
        let name = input.value.trim();
        if (name) {
          if (!(name in tables)) {
            tables[name] = [];
            currentTable = name;
            saveTables(tables);
            refreshTableSelects();
            renderTable();
            modal.remove();
          } else {
            alert('项目名称已存在！');
          }
        } else {
          alert('请输入项目名称！');
        }
      };
      
      input.onkeydown = function(e) {
        if (e.key === 'Enter') {
          saveBtn.click();
        } else if (e.key === 'Escape') {
          cancelBtn.click();
        }
      };
      
      // 点击背景关闭
      modal.onclick = function(e) {
        if (e.target === modal) {
          modal.remove();
        }
      };
      
      console.log('Modal created and added to DOM'); // 调试信息
    }

    document.getElementById('tableSelect').onfocus = function() {
      lastTable = this.value;
    };
    document.getElementById('tableSelect').onchange = function() {
      console.log('tableSelect changed to:', this.value); // 调试信息
      currentTable = this.value;
      renderTable();
      document.getElementById('viewSelect').value = currentTable;
    };
    document.getElementById('viewSelect').onchange = function() {
      currentTable = this.value;
      document.getElementById('tableSelect').value = currentTable;
      renderTable();
    };
    
    // 新建项目按钮事件
    document.getElementById('addTableBtn').onclick = function() {
      showAddTableDialog();
    };

    // 识别数据
    function parseInput(text) {
      let finish = /Finished In: ([0-9:.]+)/.exec(text);
      let kpm = /Kills per Minute: ([0-9.]+)/.exec(text);
      let kps = /Kills per Second: ([0-9.]+)/.exec(text);
      let spk = /Shots per Kill: ([0-9.]+)/.exec(text);
      if (!finish || !kpm || !kps || !spk) return null;
      let shotsPerKill = parseFloat(spk[1]);
      return {
        trainTime: new Date().toISOString(),
        finishTime: finish[1],
        killsPerMin: kpm[1],
        killsPerSec: kps[1],
        shotsPerKill: (shotsPerKill ? (1 / shotsPerKill).toFixed(3) : '')
      };
    }

    function getTrainTime() {
      const type = document.getElementById('trainTimeType').value;
      if (type === 'custom') {
        let val = document.getElementById('customTrainTime').value;
        if (val) return new Date(val).toISOString();
      }
      return new Date().toISOString();
    }
    document.getElementById('trainTimeType').onchange = function() {
      document.getElementById('customTrainTime').style.display = this.value === 'custom' ? '' : 'none';
    };

    // 录入数据
    function submitDataInput() {
      if (!currentTable) return alert(LANGS[lang].pleaseSelectTable);
      let text = document.getElementById('dataInput').value.trim();
      let data = parseInput(text);
      if (!data) return alert(LANGS[lang].notRecognized);
      data.trainTime = getTrainTime();
      tables[currentTable].push(JSON.parse(JSON.stringify(data)));
      saveTables(tables);
      renderTable();
      document.getElementById('dataInput').value = '';
    }
    document.getElementById('parseBtn').onclick = submitDataInput;
    document.getElementById('dataInput').onkeydown = function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        submitDataInput();
      }
    };

    // 手动添加数据
    document.getElementById('manualAddBtn').onclick = function() {
      if (!currentTable) return alert(LANGS[lang].pleaseSelectTable);
      let L = LANGS[lang];
      let html = '<div id="manualModal" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:#0008;z-index:2000;display:flex;align-items:center;justify-content:center;">'+
        '<div style="background:#fff;padding:28px 24px;border-radius:10px;min-width:320px;max-width:90vw;box-shadow:0 2px 12px #2196f355;display:flex;flex-direction:column;gap:14px;">'+
        '<h3 style="margin:0 0 8px 0;color:#1565c0;">'+L.manualAddTitle+'</h3>';
      for (let col of COLUMNS) {
        if (col.key === 'trainTime') {
          html += '<label>'+col.label+'<input type="datetime-local" id="manual_'+col.key+'" style="margin-left:8px;" value="'+formatDateLocal(new Date())+'"></label>';
        } else {
          html += '<label>'+col.label+'<input type="text" id="manual_'+col.key+'" style="margin-left:8px;" value=""></label>';
        }
      }
      html += '<div style="display:flex;gap:16px;justify-content:center;margin-top:10px;">'+
        '<button id="manualSaveBtn" style="background:#2196f3;color:#fff;padding:6px 18px;border:none;border-radius:6px;font-size:15px;">'+L.manualSave+'</button>'+ 
        '<button id="manualCancelBtn" style="background:#eee;color:#333;padding:6px 18px;border:none;border-radius:6px;font-size:15px;">'+L.manualCancel+'</button>'+ 
        '</div></div></div>';
      document.body.insertAdjacentHTML('beforeend', html);
      document.getElementById('manualCancelBtn').onclick = function() {
        document.getElementById('manualModal').remove();
      };
      document.getElementById('manualSaveBtn').onclick = function() {
        let d = {};
        for (let col of COLUMNS) {
          let v = document.getElementById('manual_'+col.key).value;
          if (col.key === 'trainTime') {
            d[col.key] = v ? new Date(v).toISOString() : new Date().toISOString();
          } else {
            d[col.key] = v;
          }
        }
        tables[currentTable].push(JSON.parse(JSON.stringify(d)));
        saveTables(tables);
        renderTable();
        document.getElementById('manualModal').remove();
      };
    };

    // 渲染表格和图表
    function renderTable() {
      refreshTableSelects();
      if (!currentTable || !(currentTable in tables)) return;
      let data = tables[currentTable] || [];
      // 排序与筛选状态
      let sortCol = null, sortDir = 'desc';
      let filter = { timeFrom: '', timeTo: '', min: {}, max: {} };
      // 表头
      const L = LANGS[lang];
      let th = '<tr>';
      for (let i=0;i<COLUMNS.length;i++) {
        let col = COLUMNS[i];
        th += '<th>'+L.labels[i]+'</th>';
      }
      th += '<th>'+L.del+'/'+L.edit+'</th></tr>';
      document.getElementById('tableHeader').innerHTML = th;
      // 标签行
      let labelRow = '<tr>';
      for (let col of COLUMNS) labelRow += '<td style="color:#2196f3;font-weight:600;">'+L.labels[COLUMNS.indexOf(col)]+'</td>';
      labelRow += '<td></td></tr>';
      // 数据行
      // 按训练时间降序排列（最新在最上面）
      let dataWithIndex = data.map((row, origIdx) => ({row, origIdx}));
      dataWithIndex.sort((a, b) => b.row.trainTime.localeCompare(a.row.trainTime));
      let rows = dataWithIndex.map(({row, origIdx}) => {
        let tds = '';
        for (let col of COLUMNS) {
          let v = row[col.key];
          let show = v;
          if (col.key === 'trainTime') show = formatDate(new Date(v));
          tds += '<td data-tooltip="'+L.labels[COLUMNS.indexOf(col)]+'">'+show+'</td>';
        }
        tds += '<td>'+ 
          '<button onclick="editData('+origIdx+')" style="color:#2196f3;border:none;background:none;cursor:pointer;margin-right:8px;">'+L.edit+'</button>'+
          '<button onclick="deleteData('+origIdx+')" style="color:#f44336;border:none;background:none;cursor:pointer;">'+L.del+'</button>'+
        '</td>';
        return '<tr>'+tds+'</tr>';
      }).join('');
      document.getElementById('tableBody').innerHTML = labelRow + rows;
      renderCharts(data);
    }

    // 删除数据
    window.deleteData = function(idx) {
      if (!currentTable) return alert(LANGS[lang].pleaseSelectTable);
      if (!confirm(LANGS[lang].confirmDeleteRow)) return;
      if (!tables[currentTable] || idx < 0 || idx >= tables[currentTable].length) return;
      tables[currentTable].splice(idx, 1);
      saveTables(tables);
      renderTable();
    };
    document.getElementById('deleteAllBtn').onclick = function() {
      if (!currentTable) return alert(LANGS[lang].pleaseSelectTable);
      if (!confirm(LANGS[lang].confirmDeleteAll)) return;
      tables[currentTable] = [];
      saveTables(tables);
      renderTable();
      renderStatsPanel();
    };

    // 导出当前表格
    document.getElementById('exportCurrentBtn').onclick = function() {
      if (!currentTable) return;
      exportTableToExcel(currentTable, tables[currentTable]);
    };
    // 导出所有表格
    document.getElementById('exportAllBtn').onclick = function() {
      for (let name in tables) {
        exportTableToExcel(name, tables[name]);
      }
    };
    function exportTableToExcel(name, data) {
      let ws = XLSX.utils.json_to_sheet(data.map(row => {
        let obj = {};
        for (let col of COLUMNS) obj[col.label] = col.key === 'trainTime' ? formatDate(new Date(row[col.key])) : row[col.key];
        return obj;
      }));
      let wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, name);
      XLSX.writeFile(wb, name + '.xlsx');
    }

    // 导入数据
    document.getElementById('importBtn').onclick = function() {
      document.getElementById('importFile').value = '';
      document.getElementById('importFile').click();
    };
    document.getElementById('importFile').onchange = function(e) {
      let file = e.target.files[0];
      if (!file) return;
      let reader = new FileReader();
      reader.onload = function(evt) {
        let data = new Uint8Array(evt.target.result);
        let workbook = XLSX.read(data, {type:'array'});
        for (let sheetName of workbook.SheetNames) {
          let arr = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
          if (!(sheetName in tables)) tables[sheetName] = [];
          for (let row of arr) {
            let obj = {};
            for (let col of COLUMNS) {
              let v = row[col.label];
              if (col.key === 'trainTime') {
                // 兼容格式
                let d = v ? new Date(v) : new Date();
                obj[col.key] = d.toISOString();
              } else {
                obj[col.key] = v;
              }
            }
            tables[sheetName].push(obj);
          }
        }
        saveTables(tables);
        refreshTableSelects();
        renderTable();
        renderStatsPanel();
        alert('导入成功！');
      };
      reader.readAsArrayBuffer(file);
      this.value = '';
    };

    // 渲染图表
    function renderCharts(data) {
      if (!window.Chart) return;
      if (!Array.isArray(data)) data = [];
      // 按训练时间升序
      let chartData = data.slice().sort((a,b)=>a.trainTime.localeCompare(b.trainTime));
      let labels = chartData.map(row => formatDate(new Date(row.trainTime)));
      let chartTitles = LANGS[lang].chartTitles;
      let bests = [null,null,null,null];
      let bestIdx = [null,null,null,null];
      let avgs = [0,0,0,0];
      let trend = [0,0,0,0];
      for (let i=0;i<4;i++) {
        let vals = chartData.map(row => CHARTS[i].parser(row[CHARTS[i].key]));
        if (!vals.length) continue;
        avgs[i] = vals.reduce((a,b)=>a+b,0)/vals.length;
        // 最好成绩
        if (i===0) { // 完成时间最小
          let min = Math.min(...vals);
          bests[i] = min;
          bestIdx[i] = vals.indexOf(min);
        } else { // 其他最大
          let max = Math.max(...vals);
          bests[i] = max;
          bestIdx[i] = vals.indexOf(max);
        }
        // 趋势线
        if (vals.length>1) {
          let n = vals.length;
          let x = Array.from({length:n},(_,i)=>i+1);
          let avgX = (n+1)/2;
          let avgY = avgs[i];
          let num = 0, den = 0;
          for (let j=0;j<n;j++) {
            num += (x[j]-avgX)*(vals[j]-avgY);
            den += (x[j]-avgX)*(x[j]-avgX);
          }
          trend[i] = den ? num/den : 0;
        }
      }
      // 销毁旧图表
      for (let c of chartObjs) c && c.destroy && c.destroy();
      chartObjs = [];
      for (let i=0;i<4;i++) {
        let ctx = document.getElementById('chart'+(i+1)).getContext('2d');
        let vals = chartData.map(row => CHARTS[i].parser(row[CHARTS[i].key]));
        let avg = avgs[i];
        let best = bests[i];
        let bestIndex = bestIdx[i];
        let trendVal = trend[i];
        let datasets = [
          { label: chartTitles[i], data: vals, borderColor: '#2196f3', backgroundColor: 'rgba(33,150,243,0.08)', fill: false, tension:0.2, pointRadius:4, pointBackgroundColor:vals.map((v,idx)=>idx===bestIndex?'#e53935':'#2196f3') },
          { label: LANGS[lang].avgLine, data: Array(vals.length).fill(avg), borderDash:[8,4], borderColor:'#4caf50', borderWidth:1.5, fill:false, pointRadius:0, pointHoverRadius:0, pointBackgroundColor:'transparent' },
          { label: LANGS[lang].trendLine, data: getTrendline(vals), borderDash:[2,2], borderColor:'#ff9800', borderWidth:1, fill:false, pointRadius:0, pointHoverRadius:0, pointBackgroundColor:'transparent' }
        ];
        chartObjs[i] = new Chart(ctx, {
          type: 'line',
          data: { labels, datasets },
          options: {
            responsive:true,
            plugins:{ legend:{display:true, position:'top'} },
            scales:{ y:{ beginAtZero:false, title:{display:true,text:CHARTS[i].yLabel} }, x:{ title:{display:false} } }
          }
        });
        document.getElementById('chart-title-'+(i+1)).textContent = chartTitles[i];
        // 最好成绩和激励语
        let bestStr = i===0 ? secondsToTimeStr(best) : (best||'');
        let bestLab = i===0 ? LANGS[lang].bestShort : LANGS[lang].bestHigh;
        let congrats = (chartData.length && bestIndex===chartData.length-1) ? ' <span class="congrats" style="color:#e53935;font-weight:bold;">'+LANGS[lang].congrats+'</span>' : '';
        let trendText = '';
        if (trendVal!==0) {
          if (i===0) trendText = trendVal<0 ? '<span style="color:#43a047;font-weight:bold;">'+LANGS[lang].great+'</span>' : '<span style="color:#e53935;font-weight:bold;">'+LANGS[lang].tryHard+'</span>';
          else trendText = trendVal>0 ? '<span style="color:#43a047;font-weight:bold;">'+LANGS[lang].great+'</span>' : '<span style="color:#e53935;font-weight:bold;">'+LANGS[lang].tryHard+'</span>';
        }
        document.getElementById('chart-best-'+(i+1)).innerHTML = bestLab+'：<span>'+bestStr+'</span>'+congrats+'<br>'+trendText;
      }
    }
    function getTrendline(vals) {
      let n = vals.length;
      if (n<2) return Array(n).fill(vals[0]||0);
      let x = Array.from({length:n},(_,i)=>i+1);
      let avgX = (n+1)/2;
      let avgY = vals.reduce((a,b)=>a+b,0)/n;
      let num=0,den=0;
      for (let i=0;i<n;i++) { num+=(x[i]-avgX)*(vals[i]-avgY); den+=(x[i]-avgX)*(x[i]-avgX); }
      let k = den?num/den:0, b = avgY - k*avgX;
      return x.map(xi=>k*xi+b);
    }

    // 统计面板渲染
    function renderStatsPanel() {
      const statsDiv = document.getElementById('statsPanel');
      if (!currentTable || !tables[currentTable] || tables[currentTable].length === 0) {
        statsDiv.style.display = 'none';
        statsDiv.innerHTML = '';
        return;
      }
      const L = LANGS[lang];
      const data = tables[currentTable];
      // 训练次数
      const total = data.length;
      // 最近训练时间
      const lastTime = data.map(d=>d.trainTime).sort().reverse()[0];
      // 平均成绩
      let avg = [0,0,0,0];
      let best = [null,null,null,null];
      for(let i=0;i<data.length;i++){
        let row = data[i];
        for(let j=0;j<4;j++){
          let v = parseFloat(row[COLUMNS[j+1].key]);
          if(!isNaN(v)) {
            avg[j] += v;
            if(best[j]===null) best[j]=v;
            else {
              if(j===0) best[j]=Math.min(best[j],v); // 完成时间取最小
              else best[j]=Math.max(best[j],v); // 其它取最大
            }
          }
        }
      }
      for(let j=0;j<4;j++) avg[j] = avg[j]/total;
      // 进步趋势（简单线性回归斜率）
      function getTrend(vals) {
        let n=vals.length;
        if(n<2) return 0;
        let xsum=0,ysum=0,xysum=0,x2sum=0;
        for(let i=0;i<n;i++){ xsum+=i; ysum+=vals[i]; xysum+=i*vals[i]; x2sum+=i*i; }
        let slope = (n*xysum-xsum*ysum)/(n*x2sum-xsum*xsum);
        return slope;
      }
      let trends = [0,0,0,0];
      for(let j=0;j<4;j++) {
        let vals = data.map(row=>parseFloat(row[COLUMNS[j+1].key])).filter(v=>!isNaN(v));
        trends[j] = getTrend(vals);
      }
      // 渲染卡片
      let html = '<div class="stats-card" style="display:flex;gap:28px;flex-wrap:wrap;align-items:center;justify-content:center;margin:0 0 18px 0;">';
      html += '<div class="stats-item"><div class="stats-label">'+(L.totalTrain||'训练次数')+'</div><div class="stats-value">'+total+'</div></div>';
      html += '<div class="stats-item"><div class="stats-label">'+(L.lastTrain||'最近训练')+'</div><div class="stats-value">'+formatDate(new Date(lastTime))+'</div></div>';
      for(let j=0;j<4;j++) {
        let bestStr = j===0 ? secondsToTimeStr(best[j]) : (best[j]||'');
        let avgStr = j===0 ? secondsToTimeStr(avg[j]) : avg[j].toFixed(2);
        let trendStr = trends[j]===0 ? '' : (j===0 ? (trends[j]<0?'<span style="color:#43a047;">↓</span>':'<span style="color:#e53935;">↑</span>') : (trends[j]>0?'<span style="color:#43a047;">↑</span>':'<span style="color:#e53935;">↓</span>'));
        html += '<div class="stats-item"><div class="stats-label">'+L.labels[j+1]+'</div><div class="stats-value">'+bestStr+'<span class="stats-sub">(最佳)</span></div><div class="stats-value" style="font-size:13px;color:#888;margin-top:2px;">'+avgStr+'<span class="stats-sub">(均值)</span> '+trendStr+'</div></div>';
      }
      html += '</div>';
      statsDiv.innerHTML = html;
      statsDiv.style.display = '';
    }

    // 统计面板样式
    const statsPanelStyle = `
    .stats-card { background: #e3f2fd; border-radius: 14px; box-shadow: 0 2px 12px #2196f344; padding: 18px 24px; justify-content: center; }
    .night .stats-card { background: #23283a; box-shadow: 0 2px 12px #1565c044; }
    .stats-item { min-width: 120px; margin-right: 8px; }
    .stats-label { font-size: 14px; color: #1565c0; font-weight: 600; margin-bottom: 2px; }
    .night .stats-label { color: #90caf9; }
    .stats-value { font-size: 18px; font-weight: bold; color: #1976d2; }
    .night .stats-value { color: #90caf9; }
    .stats-sub { font-size: 12px; color: #888; margin-left: 2px; }
    @media (max-width: 600px) { .stats-card { flex-direction: column; gap: 10px; padding: 12px 6px; align-items: center; } .stats-item { min-width: 90px; } }
    `;
    if (!document.getElementById('statsPanelStyle')) {
      let style = document.createElement('style');
      style.id = 'statsPanelStyle';
      style.innerHTML = statsPanelStyle;
      document.head.appendChild(style);
    }

    // 悬停显示标签
    let tooltipTimer = null;
    document.getElementById('tableBody').addEventListener('mouseover', function(e) {
      if (e.target.tagName==='TD' && e.target.dataset.tooltip) {
        tooltipTimer = setTimeout(()=>{ e.target.classList.add('show-tooltip'); }, 1000);
      }
    });
    document.getElementById('tableBody').addEventListener('mouseout', function(e) {
      if (e.target.tagName==='TD' && e.target.dataset.tooltip) {
        clearTimeout(tooltipTimer); e.target.classList.remove('show-tooltip');
      }
    });

    // 意见反馈
    document.getElementById('feedbackBtn').onclick = function() {
      alert(LANGS[lang].feedbackMsg);
    };

    // 删除训练项目
    document.getElementById('deleteTableBtn').onclick = function() {
      if (!currentTable) return alert(LANGS[lang].pleaseSelectTable);
      if (!confirm(LANGS[lang].confirmDeleteTable)) return;
      delete tables[currentTable];
      saveTables(tables);
      refreshTableSelects();
      renderTable();
    };

    // 修改数据
    window.editData = function(idx) {
      if (!currentTable) return alert(LANGS[lang].pleaseSelectTable);
      let row = tables[currentTable][idx];
      let L = LANGS[lang];
      let html = '<div id="editModal" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:#0008;z-index:2000;display:flex;align-items:center;justify-content:center;">'+
        '<div style="background:#fff;padding:28px 24px;border-radius:10px;min-width:320px;max-width:90vw;box-shadow:0 2px 12px #2196f355;display:flex;flex-direction:column;gap:14px;">'+
        '<h3 style="margin:0 0 8px 0;color:#1565c0;">'+L.editTitle+'</h3>';
      for (let col of COLUMNS) {
        let v = row[col.key];
        if (col.key === 'trainTime') {
          let localVal = v ? formatDateLocal(new Date(v)) : formatDateLocal(new Date());
          html += '<label>'+col.label+'<input type="datetime-local" id="edit_'+col.key+'" style="margin-left:8px;" value="'+localVal+'"></label>';
        } else {
          html += '<label>'+col.label+'<input type="text" id="edit_'+col.key+'" style="margin-left:8px;" value="'+(v||'')+'"></label>';
        }
      }
      html += '<div style="display:flex;gap:16px;justify-content:center;margin-top:10px;">'+
        '<button id="editSaveBtn" style="background:#2196f3;color:#fff;padding:6px 18px;border:none;border-radius:6px;font-size:15px;">'+L.editSave+'</button>'+ 
        '<button id="editCancelBtn" style="background:#eee;color:#333;padding:6px 18px;border:none;border-radius:6px;font-size:15px;">'+L.editCancel+'</button>'+ 
        '</div></div></div>';
      document.body.insertAdjacentHTML('beforeend', html);
      document.getElementById('editCancelBtn').onclick = function() {
        document.getElementById('editModal').remove();
      };
      document.getElementById('editSaveBtn').onclick = function() {
        for (let col of COLUMNS) {
          let v = document.getElementById('edit_'+col.key).value;
          if (col.key === 'trainTime') {
            row[col.key] = v ? new Date(v).toISOString() : new Date().toISOString();
          } else {
            row[col.key] = v;
          }
        }
        tables[currentTable][idx] = JSON.parse(JSON.stringify(row));
        saveTables(tables);
        renderTable();
        document.getElementById('editModal').remove();
      };
    };

    // 自动保存提示
    let saveTipTimer = null;
    function showSaveTip() {
      let tip = document.getElementById('saveTip');
      if (!tip) {
        tip = document.createElement('div');
        tip.id = 'saveTip';
        tip.style.position = 'fixed';
        tip.style.bottom = '32px';
        tip.style.left = '32px';
        tip.style.background = '#2196f3';
        tip.style.color = '#fff';
        tip.style.padding = '10px 22px';
        tip.style.borderRadius = '8px';
        tip.style.fontSize = '16px';
        tip.style.boxShadow = '0 2px 8px #2196f355';
        tip.style.zIndex = 3000;
        tip.style.opacity = 0;
        tip.style.transition = 'opacity 0.3s';
        document.body.appendChild(tip);
      }
      tip.textContent = LANGS[lang].saveTip || '已保存';
      tip.style.opacity = 1;
      clearTimeout(saveTipTimer);
      saveTipTimer = setTimeout(()=>{ tip.style.opacity = 0; }, 1800);
    }

    // 备份数据（导出JSON）
    document.getElementById('backupBtn').onclick = function() {
      const data = localStorage.getItem('aimbotz_local_data_tables') || '{}';
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'aimbotz_backup_'+(new Date().toISOString().slice(0,10))+'.json';
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
    };
    // 恢复数据（导入JSON）
    document.getElementById('restoreBtn').onclick = function() {
      let input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json,application/json';
      input.onchange = function(e) {
        let file = e.target.files[0];
        if (!file) return;
        let reader = new FileReader();
        reader.onload = function(ev) {
          try {
            let obj = JSON.parse(ev.target.result);
            if (typeof obj !== 'object' || Array.isArray(obj)) throw 0;
            // 审查机制：全表去重
            let oldTables = loadTables();
            let merged = {};
            for (let key in obj) {
              let arr = obj[key] || [];
              let exist = (oldTables[key]||[]).map(row=>JSON.stringify(row));
              merged[key] = (oldTables[key]||[]).concat(arr.filter(row=>!exist.includes(JSON.stringify(row))));
            }
            tables = merged;
            saveTables(tables);
            refreshTableSelects();
            renderTable();
            renderStatsPanel();
            showSaveTip();
            alert((LANGS[lang].restoreSuccess)||'恢复成功！');
          } catch {
            alert((LANGS[lang].restoreFail)||'恢复失败，文件格式不正确！');
          }
        };
        reader.readAsText(file);
      };
      input.click();
    };

    // 主题切换
    const THEME_KEY = 'aimbotz_theme';
    let theme = localStorage.getItem(THEME_KEY) || 'light';
    function setTheme(t) {
      theme = t;
      localStorage.setItem(THEME_KEY, t);
      if (t === 'night') document.body.classList.add('night');
      else document.body.classList.remove('night');
      renderThemeBtn();
    }
    function renderThemeBtn() {
      const btn = document.getElementById('themeToggleBtn');
      btn.textContent = (lang==='zh') ? (theme==='night'?'日间模式':'夜间模式') : (theme==='night'?'Day Mode':'Night Mode');
    }
    document.getElementById('themeToggleBtn').onclick = function() {
      setTheme(theme==='night'?'light':'night');
    };
    // 语言切换时同步主题按钮文字
    const _setLang = setLang;
    setLang = function(l) {
      _setLang(l);
      renderThemeBtn();
    };
    // 页面加载时应用主题
    setTheme(theme);

    // 排序函数
    window.sortTable = function(key) {
      if (sortCol===key) sortDir = (sortDir==='asc'?'desc':'asc');
      else { sortCol=key; sortDir='asc'; }
      renderTable();
    }

    // 导出/导入菜单弹窗
    function showMenuDialog(type) {
      let L = LANGS[lang];
      let html = '<div id="menuDialog" style="position:fixed;z-index:3002;top:0;left:0;width:100vw;height:100vh;display:flex;align-items:center;justify-content:center;background:#0005;">';
      html += '<div class="menu-dialog-box" style="background:'+(theme==='night'?'#23283a':'#fff')+';color:'+(theme==='night'?'#e3e6ef':'#222')+';padding:32px 28px 24px 28px;border-radius:16px;min-width:220px;max-width:96vw;box-shadow:0 4px 24px #2196f355;display:flex;flex-direction:column;gap:18px;align-items:center;">';
      html += '<h3 style="margin:0 0 12px 0;font-size:20px;color:#1565c0;letter-spacing:1px;">'+(type==='export'?L.export:L.import)+'</h3>';
      if(type==='export') {
        html += '<button id="exportExcelBtn" class="blue-btn" style="width:160px;margin-bottom:8px;">'+(L.exportExcel||'导出Excel')+'</button>';
        html += '<button id="exportJsonBtn" class="blue-btn" style="width:160px;">'+(L.exportJson||'导出JSON备份')+'</button>';
      } else {
        html += '<button id="importExcelBtn" class="blue-btn" style="width:160px;margin-bottom:8px;">'+(L.importExcel||'导入Excel')+'</button>';
        html += '<button id="importJsonBtn" class="blue-btn" style="width:160px;">'+(L.importJson||'导入JSON备份')+'</button>';
      }
      html += '<button id="menuDialogCancel" class="red-btn" style="width:160px;margin-top:16px;">'+(L.cancel||'取消')+'</button>';
      html += '</div></div>';
      document.body.insertAdjacentHTML('beforeend', html);
      document.getElementById('menuDialogCancel').onclick = function(){ document.getElementById('menuDialog').remove(); };
      if(type==='export') {
        document.getElementById('exportExcelBtn').onclick = function(){ document.getElementById('menuDialog').remove(); document.getElementById('exportCurrentBtn').click(); };
        document.getElementById('exportJsonBtn').onclick = function(){ document.getElementById('menuDialog').remove(); document.getElementById('backupBtn').click(); };
      } else {
        document.getElementById('importExcelBtn').onclick = function(){ document.getElementById('menuDialog').remove(); document.getElementById('importBtn').click(); };
        document.getElementById('importJsonBtn').onclick = function(){ document.getElementById('menuDialog').remove(); document.getElementById('restoreBtn').click(); };
      }
      document.getElementById('menuDialog').onclick = function(e){ if(e.target===this) this.remove(); };
    }
    document.getElementById('exportMenuBtn').onclick = function(){ showMenuDialog('export'); };
    document.getElementById('importMenuBtn').onclick = function(){ showMenuDialog('import'); };

    // 悬浮跳转按钮逻辑
    document.getElementById('gotoTableBtn').onclick = function() {
      window.scrollTo({top:0, left:0, behavior:'smooth'});
    };
    document.getElementById('gotoChartsBtn').onclick = function() {
      const charts = document.querySelector('.charts');
      if(charts) charts.scrollIntoView({behavior:'smooth', block:'center'});
    };

    // 初始化渲染
    refreshTableSelects();
    renderTable();
    renderStatsPanel();
    renderLang();
  </script>
</body>
</html> 