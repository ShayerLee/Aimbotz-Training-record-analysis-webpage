<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Aimbotzè®­ç»ƒæ•°æ®è®°å½•ä¸åˆ†æï¼ˆæœ¬åœ°ç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: 'Microsoft YaHei', Arial, sans-serif; margin: 0; padding: 0; background: #f4f8fb; }
    .top-bg { width: 100%; height: 320px; background: linear-gradient(135deg, #2196f3 60%, #1565c0 100%); background-image: url('image/bg.png'), url('image/bg.jpg'); background-size: cover; background-position: center; position: absolute; top: 0; left: 0; z-index: 0; filter: brightness(0.7) saturate(1.2); }
    .container { max-width: 1200px; margin: 0 auto; background: #fff; border-radius: 12px; box-shadow: 0 4px 24px #1565c033; padding: 36px 32px 32px 32px; position: relative; z-index: 1; margin-top: 160px; }
    h1 { text-align: center; margin-bottom: 28px; color: #1565c0; letter-spacing: 2px; font-weight: 700; font-size: 2.2rem; text-shadow: 0 2px 8px #2196f355; }
    .input-row, .view-row { display: flex; gap: 14px; align-items: center; margin-bottom: 22px; justify-content: center; }
    .input-row { gap:24px; justify-content:center; align-items:stretch; flex-wrap:wrap; }
    .input-row textarea { resize:vertical; max-width:600px; width:100%; font-size:16px; padding:10px 14px; border:1.5px solid #2196f3; border-radius:6px; background:#f4f8fb; height:100%; min-height:160px; box-sizing:border-box; }
    .data-section { display: flex; gap: 36px; align-items: flex-start; margin-top: 18px; flex-wrap: wrap; box-sizing: border-box; }
    .data-table { overflow-x: auto; max-height: 420px; border-radius: 8px; border: 1.5px solid #e3f2fd; background: #fafdff; box-shadow: 0 2px 8px #2196f322; }
    table { border-collapse: collapse; min-width: 650px; width: 100%; font-size: 15px; background: #fafdff; }
    th, td { padding: 10px 14px; border-bottom: 1px solid #e3f2fd; text-align: center; }
    th { background: #e3f2fd; color: #1565c0; font-weight: 600; position: sticky; top: 0; z-index: 1; font-size: 16px; }
    tr:last-child td { border-bottom: none; }
    .charts { display: grid; grid-template-columns: 1fr 1fr; gap: 28px 24px; min-width: 0; width: 100%; box-sizing: border-box; max-width: 100%; }
    .chart-container { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #2196f322; padding: 18px 12px 8px 12px; border: 1.5px solid #e3f2fd; display: flex; flex-direction: column; align-items: center; box-sizing: border-box; max-width: 100%; min-width: 0; }
    .chart-title { font-size: 16px; color: #1565c0; font-weight: 600; margin-bottom: 4px; letter-spacing: 1px; text-align: center; }
    .chart-best { font-size: 14px; color: #1565c0; text-align: center; margin-top: 6px; }
    .chart-best span { color: #e53935; font-weight: 700; }
    .chart-best span.congrats {
      display: inline-block;
      animation: congrats-scale 1.2s infinite cubic-bezier(.4,1.6,.4,1);
    }
    @keyframes congrats-scale {
      0% { transform: scale(1); }
      30% { transform: scale(1.25); }
      60% { transform: scale(0.95); }
      100% { transform: scale(1); }
    }
    @media (max-width: 900px) { .data-section { flex-direction: column; } .charts { grid-template-columns: 1fr; min-width: 0; } .container { padding: 12px 2vw 12px 2vw; margin-top: 80px; } }
    @media (max-width: 600px) { .container { padding: 4px 1vw 4px 1vw; } .charts { gap: 8px; } .chart-container { padding: 4px 1px 2px 1px; } table { min-width: 320px; font-size: 13px; } th, td { padding: 6px 4px; } .data-table { max-height: 220px; } }
    td[data-tooltip]::after { content: attr(data-tooltip); position: absolute; left: 50%; top: 100%; transform: translateX(-50%); background: #1565c0; color: #fff; font-size: 13px; padding: 4px 10px; border-radius: 6px; white-space: nowrap; z-index: 1002; margin-top: 4px; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
    td.show-tooltip[data-tooltip]::after { opacity: 1; }
    td { position: relative; }
    body.night, .night .container, .night .top-bg {
      background: #181c24 !important;
      color: #e3e6ef !important;
    }
    body.night .container {
      background: #23283a !important;
      color: #e3e6ef !important;
    }
    body.night .top-bg {
      background: linear-gradient(120deg,#23283a 0%,#181c24 100%) !important;
      opacity: 0.95 !important;
    }
    body.night .input-row textarea,
    body.night select,
    body.night input[type="datetime-local"] {
      background: #23283a !important;
      color: #e3e6ef !important;
      border-color: #3a4a6a !important;
    }
    body.night button {
      background: #23283a !important;
      color: #90caf9 !important;
      border-color: #3a4a6a !important;
    }
    body.night th, body.night td {
      background: #23283a !important;
      color: #e3e6ef !important;
    }
    body.night .chart-best span.congrats {
      color: #ff5252 !important;
    }
    body.night #saveTip {
      background: #1565c0 !important;
      color: #fff !important;
    }
    body.night .data-ops button {
      background: #23283a !important;
      color: #90caf9 !important;
      border-color: #3a4a6a !important;
    }
    body.night .data-ops button:hover {
      background: #1e2230 !important;
    }
    body.night .ad-box {
      background: #23283a !important;
      border-color: #3a4a6a !important;
    }
    body.night .modal, body.night #manualModal, body.night #editModal {
      background: #23283a !important;
      color: #e3e6ef !important;
    }
    body.night .modal input, body.night .modal textarea {
      background: #181c24 !important;
      color: #e3e6ef !important;
      border-color: #3a4a6a !important;
    }
    body.night .modal button {
      background: #23283a !important;
      color: #90caf9 !important;
      border-color: #3a4a6a !important;
    }
    body.night .modal button:hover {
      background: #1e2230 !important;
    }
    .blue-btn {
      background: #2196f3;
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 8px 22px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 8px #2196f355;
      transition: background 0.2s, box-shadow 0.2s;
      margin-right: 2px;
    }
    .blue-btn:hover, .blue-btn:focus {
      background: #1565c0;
      box-shadow: 0 4px 16px #2196f366;
    }
    .red-btn {
      background: #f44336;
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 8px 22px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 8px #f4433655;
      transition: background 0.2s, box-shadow 0.2s;
      margin-right: 2px;
    }
    .red-btn:hover, .red-btn:focus {
      background: #b71c1c;
      box-shadow: 0 4px 16px #f4433666;
    }
    select:focus {
      border-color: #1565c0 !important;
      box-shadow: 0 0 0 2px #2196f355 !important;
    }
    @media (max-width: 600px) {
      .blue-btn, .red-btn {
        padding: 8px 10px;
        font-size: 14px;
      }
      select {
        font-size: 14px !important;
      }
    }
    .menu-dialog-box {
      border: 2.5px solid #2196f3;
      box-shadow: 0 4px 24px #2196f355, 0 1.5px 8px #1565c055;
      animation: menudialog-pop 0.22s cubic-bezier(.4,1.6,.4,1);
    }
    @keyframes menudialog-pop {
      0% { transform: scale(0.85); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
    .menu-dialog-box button.blue-btn, .menu-dialog-box button.red-btn {
      margin-bottom: 0;
      margin-top: 0;
    }
    .menu-dialog-box h3 {
      font-weight: 700;
      letter-spacing: 1px;
    }
    /* ç»Ÿè®¡é¢æ¿æ ·å¼ */
    .stats-card { background: #e3f2fd; border-radius: 14px; box-shadow: 0 2px 12px #2196f344; padding: 18px 24px; justify-content: center; }
    .night .stats-card { background: #23283a; box-shadow: 0 2px 12px #1565c044; }
    .stats-item { min-width: 120px; margin-right: 8px; }
    .stats-label { font-size: 14px; color: #1565c0; font-weight: 600; margin-bottom: 2px; }
    .night .stats-label { color: #90caf9; }
    .stats-value { font-size: 18px; font-weight: bold; color: #1976d2; }
    .night .stats-value { color: #90caf9; }
    .stats-sub { font-size: 12px; color: #888; margin-left: 2px; }
    @media (max-width: 600px) { .stats-card { flex-direction: column; gap: 10px; padding: 12px 6px; align-items: center; } .stats-item { min-width: 90px; } }
    @media (max-width: 900px) {
      #sideOps { max-width: 100vw !important; min-width: 0 !important; }
      #sideOps .data-ops { flex-direction: row !important; flex-wrap: wrap; gap: 10px !important; }
      #sideOps button, #sideOps select { width: 100%; min-width: 0; }
    }
    @media (max-width: 600px) {
      #sideOps { flex-direction: row !important; gap: 8px !important; }
      #sideOps .data-ops { flex-direction: column !important; gap: 8px !important; }
      #sideOps button, #sideOps select { font-size: 14px !important; padding: 8px 10px !important; }
    }
    @media (max-width: 1200px) {
      .table-wrap table { min-width: 700px !important; }
    }
    @media (max-width: 900px) {
      .table-wrap table { min-width: 520px !important; }
    }
    @media (max-width: 600px) {
      .table-wrap table { min-width: 320px !important; }
    }
    .small-btn {
      font-size: 13px !important;
      padding: 5px 12px !important;
      border-radius: 6px !important;
      min-width: 0 !important;
      width: 100%;
      max-width: 140px;
      height: 32px;
    }
    #sideOps .data-ops { gap: 8px !important; }
    #sideOps select { max-width: 140px !important; font-size: 13px !important; padding: 4px 10px !important; height: 32px; }
    @media (max-width: 900px) {
      .small-btn { max-width: 100vw !important; }
      #sideOps select { max-width: 100vw !important; }
    }
    @media (max-width: 600px) {
      .small-btn { font-size: 12px !important; padding: 4px 6px !important; height: 28px; }
      #sideOps select { font-size: 12px !important; padding: 3px 6px !important; height: 28px; }
    }
    .main-flex-wrap {
      display: flex;
      gap: 36px;
      align-items: flex-start;
      justify-content: center;
      margin: 0 auto 0 auto;
      max-width: 1800px;
      width: 100%;
    }
    .main-table-wrap {
      flex: 3;
      min-width: 520px;
      max-width: 1400px;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      justify-content: flex-start;
    }
    .side-ops-panel {
      flex: 1;
      min-width: 180px;
      max-width: 180px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: flex-start;
      margin-top: 0;
      padding-top: 8px;
      gap: 0;
    }
    @media (max-width: 1200px) {
      .main-flex-wrap { gap: 18px; }
      .main-table-wrap { min-width: 340px; }
      .side-ops-panel { max-width: 140px; min-width: 120px; }
    }
    @media (max-width: 900px) {
      .main-flex-wrap { flex-direction: column; align-items: stretch; gap: 10px; }
      .main-table-wrap { align-items: stretch; }
      .side-ops-panel { flex-direction: row; max-width: 100vw; min-width: 0; align-items: flex-start; gap: 10px; padding-top: 0; }
      .side-ops-panel > div { flex: 1; }
    }
    @media (max-width: 600px) {
      .main-flex-wrap { gap: 4px; }
      .main-table-wrap { min-width: 0; }
      .side-ops-panel { flex-direction: column; max-width: 100vw; min-width: 0; gap: 6px; }
    }
    .float-nav-btn {
      position: fixed;
      right: 28px;
      bottom: 36px;
      z-index: 3003;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #2196f3;
      color: #fff;
      font-size: 26px;
      box-shadow: 0 2px 12px #2196f355;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s, box-shadow 0.2s, transform 0.15s;
      opacity: 0.92;
    }
    .float-nav-btn:hover { background: #1565c0; box-shadow: 0 4px 18px #2196f366; transform: scale(1.08); }
    .night .float-nav-btn { background: #1565c0; color: #fff; }
    @media (max-width: 600px) {
      .float-nav-btn { width: 38px; height: 38px; font-size: 20px; right: 12px; bottom: 18px; }
      #gotoChartsBtn { bottom: 62px !important; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div style="position:fixed;top:18px;left:18px;z-index:2001;display:flex;gap:12px;align-items:center;">
    <select id="langSelect" style="padding:4px 10px;border-radius:6px;border:1.5px solid #2196f3;font-size:15px;">
      <option value="zh">ç®€ä½“ä¸­æ–‡</option>
      <option value="en">English</option>
    </select>
    <button id="themeToggleBtn" style="padding:4px 14px;border-radius:6px;border:1.5px solid #2196f3;font-size:15px;background:#fff;color:#1565c0;cursor:pointer;">å¤œé—´æ¨¡å¼</button>
  </div>
  <div class="top-bg"></div>
  <div class="container" id="mainApp">
    <h1>Aimbotzè®­ç»ƒæ•°æ®è®°å½•ä¸åˆ†æï¼ˆæœ¬åœ°ç‰ˆï¼‰</h1>
    <div class="input-row">
      <div style="flex:2;min-width:260px;max-width:600px;display:flex;align-items:stretch;">
        <textarea id="dataInput" placeholder="è¯·è¾“å…¥è®­ç»ƒç»“æœæ–‡æœ¬ï¼Œå›è½¦å½•å…¥..." rows="8"></textarea>
      </div>
      <div style="flex:1;min-width:180px;max-width:260px;display:flex;flex-direction:column;justify-content:space-between;align-items:stretch;">
        <div style="display:flex;flex-direction:column;gap:18px;justify-content:space-between;height:100%;">
          <div style="display:flex;flex-direction:column;gap:8px;">
            <label style="margin-bottom:2px;font-size:15px;color:#1565c0;font-weight:600;">è®­ç»ƒé¡¹ç›®</label>
            <div style="display:flex;gap:8px;align-items:center;">
              <select id="tableSelect" style="flex:1;padding:7px 18px;border-radius:7px;border:1.5px solid #2196f3;font-size:15px;background:#f4f8fb;color:#1565c0;box-shadow:0 1px 6px #2196f322;outline:none;transition:border 0.2s;"></select>
              <button id="addTableBtn" style="padding:7px 12px;background:#4caf50;color:#fff;border:none;border-radius:7px;font-size:14px;cursor:pointer;box-shadow:0 1px 6px #4caf5055;transition:background 0.2s;white-space:nowrap;" title="æ–°å»ºé¡¹ç›®">â•</button>
            </div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px;">
            <label style="margin-bottom:2px;font-size:15px;color:#1565c0;font-weight:600;">è®­ç»ƒæ—¶é—´</label>
            <div style="display:flex;align-items:center;gap:6px;width:100%;">
              <select id="trainTimeType" style="flex:1;padding:7px 18px;border-radius:7px;border:1.5px solid #2196f3;font-size:15px;background:#f4f8fb;color:#1565c0;box-shadow:0 1px 6px #2196f322;outline:none;transition:border 0.2s;"><option value="now">å½“å‰æ—¶é—´</option><option value="custom">æŒ‡å®šæ—¶é—´</option></select>
              <input id="customTrainTime" type="datetime-local" style="display:none;flex:2;" />
            </div>
          </div>
        </div>
        <div style="width:100%;display:flex;gap:10px;justify-content:center;margin-top:18px;">
          <button id="parseBtn" style="width:110px;background:#2196f3;color:#fff;border:none;border-radius:6px;padding:8px 0;font-size:15px;font-weight:600;cursor:pointer;box-shadow:0 2px 8px #2196f355;transition:background 0.2s;">è¯†åˆ«æ•°æ®</button>
          <button id="manualAddBtn" style="width:110px;background:#4caf50; color:#fff;border:none;border-radius:6px;padding:8px 0;font-size:15px;font-weight:600;cursor:pointer;box-shadow:0 2px 8px #4caf5055;transition:background 0.2s;">æ‰‹åŠ¨æ·»åŠ æ•°æ®</button>
        </div>
      </div>
    </div>
    <div id="statsPanel" style="display:none;"></div>
    <div class="main-flex-wrap">
      <div class="main-table-wrap">
        <div id="dataSection" class="data-section" style="display:none;">
          <div class="table-wrap" style="overflow-x:auto;">
            <table id="dataTable" style="min-width:900px;width:100%;max-width:100%;border-collapse:collapse;">
              <thead id="tableHeader"></thead>
              <tbody id="tableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
      <div id="sideOps" class="side-ops-panel">
        <div style="display:flex;flex-direction:column;gap:10px;align-items:stretch;">
          <label for="viewSelect" style="font-size:15px;color:#1565c0;font-weight:600;">æŸ¥çœ‹æ•°æ®ï¼š</label>
          <select id="viewSelect" style="padding:4px 10px;border-radius:6px;border:1.2px solid #2196f3;font-size:13px;background:#f4f8fb;color:#1565c0;box-shadow:0 1px 4px #2196f322;outline:none;transition:border 0.2s;min-width:0;width:100%;max-width:140px;"></select>
        </div>
        <div class="data-ops" style="display:flex;flex-direction:column;gap:8px;align-items:stretch;margin-top:10px;">
          <button id="exportMenuBtn" class="blue-btn small-btn">å¯¼å‡º</button>
          <button id="importMenuBtn" class="blue-btn small-btn">å¯¼å…¥</button>
          <button id="exportCurrentBtn" style="display:none;">å¯¼å‡ºå½“å‰è¡¨æ ¼</button>
          <button id="exportAllBtn" style="display:none;">å¯¼å‡ºæ‰€æœ‰è¡¨æ ¼</button>
          <button id="importBtn" style="display:none;">å¯¼å…¥æ•°æ®</button>
          <button id="backupBtn" style="display:none;">å¤‡ä»½æ•°æ®</button>
          <button id="restoreBtn" style="display:none;">æ¢å¤æ•°æ®</button>
          <button id="deleteAllBtn" class="red-btn small-btn">åˆ é™¤å…¨éƒ¨æ•°æ®</button>
          <button id="deleteTableBtn" class="red-btn small-btn">åˆ é™¤é¡¹ç›®</button>
        </div>
        <input type="file" id="importFile" accept=".xlsx" style="display:none;" />
      </div>
    </div>
    <div class="charts">
      <div class="chart-container"><div class="chart-title" id="chart-title-1"></div><canvas id="chart1"></canvas><div class="chart-best" id="chart-best-1"></div></div>
      <div class="chart-container"><div class="chart-title" id="chart-title-2"></div><canvas id="chart2"></canvas><div class="chart-best" id="chart-best-2"></div></div>
      <div class="chart-container"><div class="chart-title" id="chart-title-3"></div><canvas id="chart3"></canvas><div class="chart-best" id="chart-best-3"></div></div>
      <div class="chart-container"><div class="chart-title" id="chart-title-4"></div><canvas id="chart4"></canvas><div class="chart-best" id="chart-best-4"></div></div>
    </div>
  </div>
  <button id="feedbackBtn" style="position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#2196f3;color:#fff;border:none;border-radius:24px;padding:10px 32px;font-size:16px;font-weight:600;box-shadow:0 2px 8px #2196f355;cursor:pointer;z-index:1001;">æ„è§åé¦ˆ</button>
  <!-- æ‚¬æµ®è·³è½¬æŒ‰é’® -->
  <button id="gotoTableBtn" class="float-nav-btn" title="è·³è½¬åˆ°è¡¨æ ¼">ğŸ“‹</button>
  <button id="gotoChartsBtn" class="float-nav-btn" title="è·³è½¬åˆ°æŠ˜çº¿å›¾" style="bottom:92px;">ğŸ“ˆ</button>
  <script>
    // æœ¬åœ°å­˜å‚¨é”®
    const STORAGE_KEY = 'aimbotz_local_data_tables';
    // è¡¨å¤´å®šä¹‰
    const COLUMNS = [
      { key: 'trainTime', label: 'è®­ç»ƒæ—¶é—´' },
      { key: 'finishTime', label: 'å®Œæˆæ—¶é—´' },
      { key: 'killsPerMin', label: 'æ¯åˆ†é’Ÿå‡»æ€' },
      { key: 'killsPerSec', label: 'æ¯ç§’å‡»æ€' },
      { key: 'shotsPerKill', label: 'å‡†ç¡®ç‡' }
    ];
    const CHARTS = [
      { key: 'finishTime', label: 'å®Œæˆæ—¶é—´', yLabel: 'ç§’', parser: v => timeStrToSeconds(v) },
      { key: 'killsPerMin', label: 'æ¯åˆ†é’Ÿå‡»æ€', yLabel: 'æ•°å€¼', parser: v => parseFloat(v) },
      { key: 'killsPerSec', label: 'æ¯ç§’å‡»æ€', yLabel: 'æ•°å€¼', parser: v => parseFloat(v) },
      { key: 'shotsPerKill', label: 'å‡†ç¡®ç‡', yLabel: 'æ•°å€¼', parser: v => parseFloat(v) }
    ];

    // æœ¬åœ°å­˜å‚¨æ“ä½œ
    function loadTables() {
      return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
    }
    function saveTables(tables) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(tables));
      showSaveTip();
    }

    // å·¥å…·å‡½æ•°
    function pad(n) { return n < 10 ? '0' + n : n; }
    function formatDate(dt) {
      return dt.getFullYear() + '-' + pad(dt.getMonth() + 1) + '-' + pad(dt.getDate()) + ' ' + pad(dt.getHours()) + ':' + pad(dt.getMinutes());
    }
    function formatDateLocal(dt) {
      return dt.getFullYear() + '-' + pad(dt.getMonth() + 1) + '-' + pad(dt.getDate()) + 'T' + pad(dt.getHours()) + ':' + pad(dt.getMinutes());
    }
    function timeStrToSeconds(str) {
      if (!str) return 0;
      let m = str.match(/(\d+):(\d+)(?:\.(\d+))?/);
      if (!m) return parseFloat(str) || 0;
      return parseInt(m[1]) * 60 + parseInt(m[2]) + (m[3] ? parseFloat('0.' + m[3]) : 0);
    }
    function secondsToTimeStr(sec) {
      let m = Math.floor(sec / 60), s = (sec % 60).toFixed(3);
      return pad(m) + ':' + pad(Math.floor(s)) + '.' + (s.split('.')[1] || '000');
    }

    // å…¨å±€å˜é‡
    let tables = loadTables();
    let currentTable = Object.keys(tables)[0] || '';
    let chartObjs = [];
    let lastTable = currentTable;

    // è¯­è¨€åŒ…
    const LANGS = {
      zh: {
        title: 'Aimbotzè®­ç»ƒæ•°æ®è®°å½•ä¸åˆ†æï¼ˆæœ¬åœ°ç‰ˆï¼‰',
        trainProject: 'è®­ç»ƒé¡¹ç›®',
        trainTime: 'è®­ç»ƒæ—¶é—´',
        now: 'å½“å‰æ—¶é—´',
        custom: 'æŒ‡å®šæ—¶é—´',
        recognize: 'è¯†åˆ«æ•°æ®',
        manualAdd: 'æ‰‹åŠ¨æ·»åŠ æ•°æ®',
        viewData: 'æŸ¥çœ‹æ•°æ®ï¼š',
        exportCurrent: 'å¯¼å‡ºå½“å‰è¡¨æ ¼',
        exportAll: 'å¯¼å‡ºæ‰€æœ‰è¡¨æ ¼',
        import: 'å¯¼å…¥æ•°æ®',
        deleteAll: 'åˆ é™¤å…¨éƒ¨æ•°æ®',
        deleteTable: 'åˆ é™¤é¡¹ç›®',
        addTable: 'â• æ–°å»ºé¡¹ç›®',
        feedback: 'æ„è§åé¦ˆ',
        feedbackMsg: 'å¦‚æœ‰å»ºè®®æˆ–é—®é¢˜ï¼Œè¯·è”ç³»å¼€å‘è€…ï¼šshayer1688@163.com',
        confirmDeleteTable: 'ç¡®å®šè¦åˆ é™¤å½“å‰è®­ç»ƒé¡¹ç›®åŠå…¶æ‰€æœ‰æ•°æ®å—ï¼Ÿ',
        confirmDeleteAll: 'ç¡®å®šè¦åˆ é™¤å½“å‰è¡¨æ ¼çš„æ‰€æœ‰æ•°æ®å—ï¼Ÿ',
        confirmDeleteRow: 'ç¡®å®šè¦åˆ é™¤è¯¥æ¡æ•°æ®å—ï¼Ÿ',
        pleaseSelectTable: 'è¯·å…ˆé€‰æ‹©è®­ç»ƒé¡¹ç›®',
        notRecognized: 'æœªè¯†åˆ«åˆ°æœ‰æ•ˆæ•°æ®ï¼',
        inputTableName: 'è¯·è¾“å…¥æ–°è®­ç»ƒé¡¹ç›®åç§°ï¼š',
        manualAddTitle: 'æ‰‹åŠ¨æ·»åŠ æ•°æ®',
        manualSave: 'ä¿å­˜',
        manualCancel: 'å–æ¶ˆ',
        editTitle: 'ä¿®æ”¹æ•°æ®',
        editSave: 'ä¿å­˜',
        editCancel: 'å–æ¶ˆ',
        bestShort: 'å†å²æœ€çŸ­',
        bestHigh: 'å†å²æœ€é«˜',
        congrats: 'æ­å–œï¼æ–°çºªå½•ï¼',
        great: 'å¹²çš„æ¼‚äº®ï¼ç»§ç»­åŠ æ²¹ï¼',
        tryHard: 'å­©å­ï¼Œè¿˜éœ€åŠªåŠ›ï¼',
        labels: ['è®­ç»ƒæ—¶é—´','å®Œæˆæ—¶é—´','æ¯åˆ†é’Ÿå‡»æ€','æ¯ç§’å‡»æ€','å‡†ç¡®ç‡'],
        chartTitles: ['å®Œæˆæ—¶é—´','æ¯åˆ†é’Ÿå‡»æ€','æ¯ç§’å‡»æ€','å‡†ç¡®ç‡'],
        avgLine: 'å¹³å‡çº¿',
        trendLine: 'è¶‹åŠ¿çº¿',
        edit: 'ä¿®æ”¹',
        del: 'åˆ é™¤',
        saveTip: 'å·²ä¿å­˜',
        restoreSuccess: 'æ¢å¤æˆåŠŸï¼',
        restoreFail: 'æ¢å¤å¤±è´¥ï¼Œæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼',
        resetFilter: 'é‡ç½®ç­›é€‰',
        filterSort: 'ç­›é€‰/æ’åº',
        filterSortTitle: 'ç­›é€‰ä¸æ’åº',
        sortBy: 'æ’åºå­—æ®µ',
        asc: 'å‡åº',
        desc: 'é™åº',
        apply: 'åº”ç”¨',
        cancel: 'å–æ¶ˆ',
        undo: 'æ’¤é”€',
        export: 'å¯¼å‡º',
        import: 'å¯¼å…¥',
        exportExcel: 'å¯¼å‡ºExcel',
        exportJson: 'å¯¼å‡ºJSONå¤‡ä»½',
        importExcel: 'å¯¼å…¥Excel',
        importJson: 'å¯¼å…¥JSONå¤‡ä»½',
        totalTrain: 'è®­ç»ƒæ¬¡æ•°',
        lastTrain: 'æœ€è¿‘è®­ç»ƒ',
      },
      en: {
        title: 'Aimbotz Training Data Tracker (Local)',
        trainProject: 'Project',
        trainTime: 'Train Time',
        now: 'Now',
        custom: 'Custom',
        recognize: 'Recognize',
        manualAdd: 'Manual Add',
        viewData: 'View:',
        exportCurrent: 'Export Current',
        exportAll: 'Export All',
        import: 'Import',
        deleteAll: 'Delete All',
        deleteTable: 'Delete Project',
        addTable: 'â• New Project',
        feedback: 'Feedback',
        feedbackMsg: 'For suggestions or issues, contact: shayer1688@163.com',
        confirmDeleteTable: 'Delete this project and all its data?',
        confirmDeleteAll: 'Delete all data in this table?',
        confirmDeleteRow: 'Delete this record?',
        pleaseSelectTable: 'Please select a project first',
        notRecognized: 'No valid data recognized!',
        inputTableName: 'Enter new project name:',
        manualAddTitle: 'Manual Add',
        manualSave: 'Save',
        manualCancel: 'Cancel',
        editTitle: 'Edit Data',
        editSave: 'Save',
        editCancel: 'Cancel',
        bestShort: 'Best (Shortest)',
        bestHigh: 'Best (Highest)',
        congrats: 'Congrats! New Record!',
        great: 'Great! Keep it up!',
        tryHard: 'Try harder!',
        labels: ['Train Time','Finish Time','Kills/Min','Kills/Sec','Accuracy'],
        chartTitles: ['Finish Time','Kills/Min','Kills/Sec','Accuracy'],
        avgLine: 'Avg',
        trendLine: 'Trend',
        edit: 'Edit',
        del: 'Delete',
        saveTip: 'Saved',
        restoreSuccess: 'Restore success!',
        restoreFail: 'Restore failed, invalid file!',
        resetFilter: 'Reset',
        filterSort: 'Filter/Sort',
        filterSortTitle: 'Filter & Sort',
        sortBy: 'Sort by',
        asc: 'Asc',
        desc: 'Desc',
        apply: 'Apply',
        cancel: 'Cancel',
        undo: 'Undo',
        export: 'Export',
        import: 'Import',
        exportExcel: 'Export Excel',
        exportJson: 'Export JSON',
        importExcel: 'Import Excel',
        importJson: 'Import JSON',
        totalTrain: 'Total',
        lastTrain: 'Last Train',
      }
    };
    let lang = localStorage.getItem('aimbotz_lang') || 'zh';
    function setLang(l) {
      lang = l;
      localStorage.setItem('aimbotz_lang', l);
      renderLang();
      renderTable();
    }
    document.getElementById('langSelect').value = lang;
    document.getElementById('langSelect').onchange = function() { setLang(this.value); };
    function renderLang() {
      const L = LANGS[lang];
      document.title = L.title;
      document.querySelector('h1').textContent = L.title;
      document.querySelector('label[for="viewSelect"]').textContent = L.viewData;
      document.getElementById('exportCurrentBtn').textContent = L.exportCurrent;
      document.getElementById('exportAllBtn').textContent = L.exportAll;
      document.getElementById('importBtn').textContent = L.import;
      document.getElementById('deleteAllBtn').textContent = L.deleteAll;
      document.getElementById('deleteTableBtn').textContent = L.deleteTable;
      document.getElementById('parseBtn').textContent = L.recognize;
      document.getElementById('manualAddBtn').textContent = L.manualAdd;
      document.getElementById('feedbackBtn').textContent = L.feedback;
      // ä¸‹æ‹‰èœå•æ ‡é¢˜
      document.querySelectorAll('.input-row label')[0].textContent = L.trainProject;
      document.querySelectorAll('.input-row label')[1].textContent = L.trainTime;
      // æ—¶é—´ä¸‹æ‹‰
      let timeSel = document.getElementById('trainTimeType');
      timeSel.options[0].text = L.now;
      timeSel.options[1].text = L.custom;
    }

    // åˆå§‹åŒ–
    function refreshTableSelects() {
      const tableSelect = document.getElementById('tableSelect');
      const viewSelect = document.getElementById('viewSelect');
      const L = LANGS[lang];
      tableSelect.innerHTML = '';
      viewSelect.innerHTML = '';
      let hasTable = false;
      for (let name of Object.keys(tables)) {
        let opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        tableSelect.appendChild(opt);
        let opt2 = document.createElement('option');
        opt2.value = name;
        opt2.textContent = name;
        viewSelect.appendChild(opt2);
        hasTable = true;
      }
      // å¦‚æœæ²¡æœ‰é¡¹ç›®ï¼Œè®¾ç½®é»˜è®¤å€¼
      if (!hasTable) {
        currentTable = '';
        tableSelect.value = '';
        viewSelect.value = '';
      } else {
        // å¦‚æœæœ‰é¡¹ç›®ï¼Œç¡®ä¿currentTableæœ‰æ•ˆ
        if (!currentTable || !(currentTable in tables)) {
          currentTable = Object.keys(tables)[0] || '';
        }
        tableSelect.value = currentTable;
        viewSelect.value = currentTable;
      }
      
      document.getElementById('dataSection').style.display = hasTable ? '' : 'none';
    }

    function showAddTableDialog() {
      console.log('showAddTableDialog called'); // è°ƒè¯•ä¿¡æ¯
      
      // å…ˆç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§å¼¹çª—
      let oldModal = document.getElementById('addTableModal');
      if (oldModal) oldModal.remove();
      
      let L = LANGS[lang];
      
      // åˆ›å»ºæ¨¡æ€æ¡†å®¹å™¨
      let modal = document.createElement('div');
      modal.id = 'addTableModal';
      modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;';
      
      // åˆ›å»ºå¼¹çª—å†…å®¹
      let content = document.createElement('div');
      content.style.cssText = 'background:white;padding:30px;border-radius:10px;min-width:300px;max-width:90%;box-shadow:0 4px 20px rgba(0,0,0,0.3);';
      
      // æ ‡é¢˜
      let title = document.createElement('h3');
      title.textContent = L.addTable;
      title.style.cssText = 'margin:0 0 20px 0;color:#1565c0;text-align:center;';
      content.appendChild(title);
      
      // è¾“å…¥æ¡†
      let input = document.createElement('input');
      input.type = 'text';
      input.id = 'newTableName';
      input.placeholder = L.inputTableName;
      input.style.cssText = 'width:100%;padding:10px;border:2px solid #2196f3;border-radius:6px;font-size:16px;margin-bottom:20px;box-sizing:border-box;';
      content.appendChild(input);
      
      // æŒ‰é’®å®¹å™¨
      let btnContainer = document.createElement('div');
      btnContainer.style.cssText = 'display:flex;gap:15px;justify-content:center;';
      
      // ç¡®å®šæŒ‰é’®
      let saveBtn = document.createElement('button');
      saveBtn.textContent = 'ç¡®å®š';
      saveBtn.style.cssText = 'background:#2196f3;color:white;padding:10px 20px;border:none;border-radius:6px;font-size:16px;cursor:pointer;';
      btnContainer.appendChild(saveBtn);
      
      // å–æ¶ˆæŒ‰é’®
      let cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'å–æ¶ˆ';
      cancelBtn.style.cssText = 'background:#ccc;color:#333;padding:10px 20px;border:none;border-radius:6px;font-size:16px;cursor:pointer;';
      btnContainer.appendChild(cancelBtn);
      
      content.appendChild(btnContainer);
      modal.appendChild(content);
      document.body.appendChild(modal);
      
      // èšç„¦åˆ°è¾“å…¥æ¡†
      input.focus();
      
      // äº‹ä»¶å¤„ç†
      cancelBtn.onclick = function() {
        modal.remove();
      };
      
      saveBtn.onclick = function() {
        let name = input.value.trim();
        if (name) {
          if (!(name in tables)) {
            tables[name] = [];
            currentTable = name;
            saveTables(tables);
            refreshTableSelects();
            renderTable();
            modal.remove();
          } else {
            alert('é¡¹ç›®åç§°å·²å­˜åœ¨ï¼');
          }
        } else {
          alert('è¯·è¾“å…¥é¡¹ç›®åç§°ï¼');
        }
      };
      
      input.onkeydown = function(e) {
        if (e.key === 'Enter') {
          saveBtn.click();
        } else if (e.key === 'Escape') {
          cancelBtn.click();
        }
      };
      
      // ç‚¹å‡»èƒŒæ™¯å…³é—­
      modal.onclick = function(e) {
        if (e.target === modal) {
          modal.remove();
        }
      };
      
      console.log('Modal created and added to DOM'); // è°ƒè¯•ä¿¡æ¯
    }

    document.getElementById('tableSelect').onfocus = function() {
      lastTable = this.value;
    };
    document.getElementById('tableSelect').onchange = function() {
      console.log('tableSelect changed to:', this.value); // è°ƒè¯•ä¿¡æ¯
      currentTable = this.value;
      renderTable();
      document.getElementById('viewSelect').value = currentTable;
    };
    document.getElementById('viewSelect').onchange = function() {
      currentTable = this.value;
      document.getElementById('tableSelect').value = currentTable;
      renderTable();
    };
    
    // æ–°å»ºé¡¹ç›®æŒ‰é’®äº‹ä»¶
    document.getElementById('addTableBtn').onclick = function() {
      showAddTableDialog();
    };

    // è¯†åˆ«æ•°æ®
    function parseInput(text) {
      let finish = /Finished In: ([0-9:.]+)/.exec(text);
      let kpm = /Kills per Minute: ([0-9.]+)/.exec(text);
      let kps = /Kills per Second: ([0-9.]+)/.exec(text);
      let spk = /Shots per Kill: ([0-9.]+)/.exec(text);
      if (!finish || !kpm || !kps || !spk) return null;
      let shotsPerKill = parseFloat(spk[1]);
      return {
        trainTime: new Date().toISOString(),
        finishTime: finish[1],
        killsPerMin: kpm[1],
        killsPerSec: kps[1],
        shotsPerKill: (shotsPerKill ? (1 / shotsPerKill).toFixed(3) : '')
      };
    }

    function getTrainTime() {
      const type = document.getElementById('trainTimeType').value;
      if (type === 'custom') {
        let val = document.getElementById('customTrainTime').value;
        if (val) return new Date(val).toISOString();
      }
      return new Date().toISOString();
    }
    document.getElementById('trainTimeType').onchange = function() {
      document.getElementById('customTrainTime').style.display = this.value === 'custom' ? '' : 'none';
    };

    // å½•å…¥æ•°æ®
    function submitDataInput() {
      if (!currentTable) return alert(LANGS[lang].pleaseSelectTable);
      let text = document.getElementById('dataInput').value.trim();
      let data = parseInput(text);
      if (!data) return alert(LANGS[lang].notRecognized);
      data.trainTime = getTrainTime();
      tables[currentTable].push(JSON.parse(JSON.stringify(data)));
      saveTables(tables);
      renderTable();
      document.getElementById('dataInput').value = '';
    }
    document.getElementById('parseBtn').onclick = submitDataInput;
    document.getElementById('dataInput').onkeydown = function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        submitDataInput();
      }
    };

    // æ‰‹åŠ¨æ·»åŠ æ•°æ®
    document.getElementById('manualAddBtn').onclick = function() {
      if (!currentTable) return alert(LANGS[lang].pleaseSelectTable);
      let L = LANGS[lang];
      let html = '<div id="manualModal" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:#0008;z-index:2000;display:flex;align-items:center;justify-content:center;">'+
        '<div style="background:#fff;padding:28px 24px;border-radius:10px;min-width:320px;max-width:90vw;box-shadow:0 2px 12px #2196f355;display:flex;flex-direction:column;gap:14px;">'+
        '<h3 style="margin:0 0 8px 0;color:#1565c0;">'+L.manualAddTitle+'</h3>';
      for (let col of COLUMNS) {
        if (col.key === 'trainTime') {
          html += '<label>'+col.label+'<input type="datetime-local" id="manual_'+col.key+'" style="margin-left:8px;" value="'+formatDateLocal(new Date())+'"></label>';
        } else {
          html += '<label>'+col.label+'<input type="text" id="manual_'+col.key+'" style="margin-left:8px;" value=""></label>';
        }
      }
      html += '<div style="display:flex;gap:16px;justify-content:center;margin-top:10px;">'+
        '<button id="manualSaveBtn" style="background:#2196f3;color:#fff;padding:6px 18px;border:none;border-radius:6px;font-size:15px;">'+L.manualSave+'</button>'+ 
        '<button id="manualCancelBtn" style="background:#eee;color:#333;padding:6px 18px;border:none;border-radius:6px;font-size:15px;">'+L.manualCancel+'</button>'+ 
        '</div></div></div>';
      document.body.insertAdjacentHTML('beforeend', html);
      document.getElementById('manualCancelBtn').onclick = function() {
        document.getElementById('manualModal').remove();
      };
      document.getElementById('manualSaveBtn').onclick = function() {
        let d = {};
        for (let col of COLUMNS) {
          let v = document.getElementById('manual_'+col.key).value;
          if (col.key === 'trainTime') {
            d[col.key] = v ? new Date(v).toISOString() : new Date().toISOString();
          } else {
            d[col.key] = v;
          }
        }
        tables[currentTable].push(JSON.parse(JSON.stringify(d)));
        saveTables(tables);
        renderTable();
        document.getElementById('manualModal').remove();
      };
    };

    // æ¸²æŸ“è¡¨æ ¼å’Œå›¾è¡¨
    function renderTable() {
      refreshTableSelects();
      if (!currentTable || !(currentTable in tables)) return;
      let data = tables[currentTable] || [];
      // æ’åºä¸ç­›é€‰çŠ¶æ€
      let sortCol = null, sortDir = 'desc';
      let filter = { timeFrom: '', timeTo: '', min: {}, max: {} };
      // è¡¨å¤´
      const L = LANGS[lang];
      let th = '<tr>';
      for (let i=0;i<COLUMNS.length;i++) {
        let col = COLUMNS[i];
        th += '<th>'+L.labels[i]+'</th>';
      }
      th += '<th>'+L.del+'/'+L.edit+'</th></tr>';
      document.getElementById('tableHeader').innerHTML = th;
      // æ ‡ç­¾è¡Œ
      let labelRow = '<tr>';
      for (let col of COLUMNS) labelRow += '<td style="color:#2196f3;font-weight:600;">'+L.labels[COLUMNS.indexOf(col)]+'</td>';
      labelRow += '<td></td></tr>';
      // æ•°æ®è¡Œ
      // æŒ‰è®­ç»ƒæ—¶é—´é™åºæ’åˆ—ï¼ˆæœ€æ–°åœ¨æœ€ä¸Šé¢ï¼‰
      let dataWithIndex = data.map((row, origIdx) => ({row, origIdx}));
      dataWithIndex.sort((a, b) => b.row.trainTime.localeCompare(a.row.trainTime));
      let rows = dataWithIndex.map(({row, origIdx}) => {
        let tds = '';
        for (let col of COLUMNS) {
          let v = row[col.key];
          let show = v;
          if (col.key === 'trainTime') show = formatDate(new Date(v));
          tds += '<td data-tooltip="'+L.labels[COLUMNS.indexOf(col)]+'">'+show+'</td>';
        }
        tds += '<td>'+ 
          '<button onclick="editData('+origIdx+')" style="color:#2196f3;border:none;background:none;cursor:pointer;margin-right:8px;">'+L.edit+'</button>'+
          '<button onclick="deleteData('+origIdx+')" style="color:#f44336;border:none;background:none;cursor:pointer;">'+L.del+'</button>'+
        '</td>';
        return '<tr>'+tds+'</tr>';
      }).join('');
      document.getElementById('tableBody').innerHTML = labelRow + rows;
      renderCharts(data);
    }

    // åˆ é™¤æ•°æ®
    window.deleteData = function(idx) {
      if (!currentTable) return alert(LANGS[lang].pleaseSelectTable);
      if (!confirm(LANGS[lang].confirmDeleteRow)) return;
      if (!tables[currentTable] || idx < 0 || idx >= tables[currentTable].length) return;
      tables[currentTable].splice(idx, 1);
      saveTables(tables);
      renderTable();
    };
    document.getElementById('deleteAllBtn').onclick = function() {
      if (!currentTable) return alert(LANGS[lang].pleaseSelectTable);
      if (!confirm(LANGS[lang].confirmDeleteAll)) return;
      tables[currentTable] = [];
      saveTables(tables);
      renderTable();
      renderStatsPanel();
    };

    // å¯¼å‡ºå½“å‰è¡¨æ ¼
    document.getElementById('exportCurrentBtn').onclick = function() {
      if (!currentTable) return;
      exportTableToExcel(currentTable, tables[currentTable]);
    };
    // å¯¼å‡ºæ‰€æœ‰è¡¨æ ¼
    document.getElementById('exportAllBtn').onclick = function() {
      for (let name in tables) {
        exportTableToExcel(name, tables[name]);
      }
    };
    function exportTableToExcel(name, data) {
      let ws = XLSX.utils.json_to_sheet(data.map(row => {
        let obj = {};
        for (let col of COLUMNS) obj[col.label] = col.key === 'trainTime' ? formatDate(new Date(row[col.key])) : row[col.key];
        return obj;
      }));
      let wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, name);
      XLSX.writeFile(wb, name + '.xlsx');
    }

    // å¯¼å…¥æ•°æ®
    document.getElementById('importBtn').onclick = function() {
      document.getElementById('importFile').value = '';
      document.getElementById('importFile').click();
    };
    document.getElementById('importFile').onchange = function(e) {
      let file = e.target.files[0];
      if (!file) return;
      let reader = new FileReader();
      reader.onload = function(evt) {
        let data = new Uint8Array(evt.target.result);
        let workbook = XLSX.read(data, {type:'array'});
        for (let sheetName of workbook.SheetNames) {
          let arr = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
          if (!(sheetName in tables)) tables[sheetName] = [];
          for (let row of arr) {
            let obj = {};
            for (let col of COLUMNS) {
              let v = row[col.label];
              if (col.key === 'trainTime') {
                // å…¼å®¹æ ¼å¼
                let d = v ? new Date(v) : new Date();
                obj[col.key] = d.toISOString();
              } else {
                obj[col.key] = v;
              }
            }
            tables[sheetName].push(obj);
          }
        }
        saveTables(tables);
        refreshTableSelects();
        renderTable();
        renderStatsPanel();
        alert('å¯¼å…¥æˆåŠŸï¼');
      };
      reader.readAsArrayBuffer(file);
      this.value = '';
    };

    // æ¸²æŸ“å›¾è¡¨
    function renderCharts(data) {
      if (!window.Chart) return;
      if (!Array.isArray(data)) data = [];
      // æŒ‰è®­ç»ƒæ—¶é—´å‡åº
      let chartData = data.slice().sort((a,b)=>a.trainTime.localeCompare(b.trainTime));
      let labels = chartData.map(row => formatDate(new Date(row.trainTime)));
      let chartTitles = LANGS[lang].chartTitles;
      let bests = [null,null,null,null];
      let bestIdx = [null,null,null,null];
      let avgs = [0,0,0,0];
      let trend = [0,0,0,0];
      for (let i=0;i<4;i++) {
        let vals = chartData.map(row => CHARTS[i].parser(row[CHARTS[i].key]));
        if (!vals.length) continue;
        avgs[i] = vals.reduce((a,b)=>a+b,0)/vals.length;
        // æœ€å¥½æˆç»©
        if (i===0) { // å®Œæˆæ—¶é—´æœ€å°
          let min = Math.min(...vals);
          bests[i] = min;
          bestIdx[i] = vals.indexOf(min);
        } else { // å…¶ä»–æœ€å¤§
          let max = Math.max(...vals);
          bests[i] = max;
          bestIdx[i] = vals.indexOf(max);
        }
        // è¶‹åŠ¿çº¿
        if (vals.length>1) {
          let n = vals.length;
          let x = Array.from({length:n},(_,i)=>i+1);
          let avgX = (n+1)/2;
          let avgY = avgs[i];
          let num = 0, den = 0;
          for (let j=0;j<n;j++) {
            num += (x[j]-avgX)*(vals[j]-avgY);
            den += (x[j]-avgX)*(x[j]-avgX);
          }
          trend[i] = den ? num/den : 0;
        }
      }
      // é”€æ¯æ—§å›¾è¡¨
      for (let c of chartObjs) c && c.destroy && c.destroy();
      chartObjs = [];
      for (let i=0;i<4;i++) {
        let ctx = document.getElementById('chart'+(i+1)).getContext('2d');
        let vals = chartData.map(row => CHARTS[i].parser(row[CHARTS[i].key]));
        let avg = avgs[i];
        let best = bests[i];
        let bestIndex = bestIdx[i];
        let trendVal = trend[i];
        let datasets = [
          { label: chartTitles[i], data: vals, borderColor: '#2196f3', backgroundColor: 'rgba(33,150,243,0.08)', fill: false, tension:0.2, pointRadius:4, pointBackgroundColor:vals.map((v,idx)=>idx===bestIndex?'#e53935':'#2196f3') },
          { label: LANGS[lang].avgLine, data: Array(vals.length).fill(avg), borderDash:[8,4], borderColor:'#4caf50', borderWidth:1.5, fill:false, pointRadius:0, pointHoverRadius:0, pointBackgroundColor:'transparent' },
          { label: LANGS[lang].trendLine, data: getTrendline(vals), borderDash:[2,2], borderColor:'#ff9800', borderWidth:1, fill:false, pointRadius:0, pointHoverRadius:0, pointBackgroundColor:'transparent' }
        ];
        chartObjs[i] = new Chart(ctx, {
          type: 'line',
          data: { labels, datasets },
          options: {
            responsive:true,
            plugins:{ legend:{display:true, position:'top'} },
            scales:{ y:{ beginAtZero:false, title:{display:true,text:CHARTS[i].yLabel} }, x:{ title:{display:false} } }
          }
        });
        document.getElementById('chart-title-'+(i+1)).textContent = chartTitles[i];
        // æœ€å¥½æˆç»©å’Œæ¿€åŠ±è¯­
        let bestStr = i===0 ? secondsToTimeStr(best) : (best||'');
        let bestLab = i===0 ? LANGS[lang].bestShort : LANGS[lang].bestHigh;
        let congrats = (chartData.length && bestIndex===chartData.length-1) ? ' <span class="congrats" style="color:#e53935;font-weight:bold;">'+LANGS[lang].congrats+'</span>' : '';
        let trendText = '';
        if (trendVal!==0) {
          if (i===0) trendText = trendVal<0 ? '<span style="color:#43a047;font-weight:bold;">'+LANGS[lang].great+'</span>' : '<span style="color:#e53935;font-weight:bold;">'+LANGS[lang].tryHard+'</span>';
          else trendText = trendVal>0 ? '<span style="color:#43a047;font-weight:bold;">'+LANGS[lang].great+'</span>' : '<span style="color:#e53935;font-weight:bold;">'+LANGS[lang].tryHard+'</span>';
        }
        document.getElementById('chart-best-'+(i+1)).innerHTML = bestLab+'ï¼š<span>'+bestStr+'</span>'+congrats+'<br>'+trendText;
      }
    }
    function getTrendline(vals) {
      let n = vals.length;
      if (n<2) return Array(n).fill(vals[0]||0);
      let x = Array.from({length:n},(_,i)=>i+1);
      let avgX = (n+1)/2;
      let avgY = vals.reduce((a,b)=>a+b,0)/n;
      let num=0,den=0;
      for (let i=0;i<n;i++) { num+=(x[i]-avgX)*(vals[i]-avgY); den+=(x[i]-avgX)*(x[i]-avgX); }
      let k = den?num/den:0, b = avgY - k*avgX;
      return x.map(xi=>k*xi+b);
    }

    // ç»Ÿè®¡é¢æ¿æ¸²æŸ“
    function renderStatsPanel() {
      const statsDiv = document.getElementById('statsPanel');
      if (!currentTable || !tables[currentTable] || tables[currentTable].length === 0) {
        statsDiv.style.display = 'none';
        statsDiv.innerHTML = '';
        return;
      }
      const L = LANGS[lang];
      const data = tables[currentTable];
      // è®­ç»ƒæ¬¡æ•°
      const total = data.length;
      // æœ€è¿‘è®­ç»ƒæ—¶é—´
      const lastTime = data.map(d=>d.trainTime).sort().reverse()[0];
      // å¹³å‡æˆç»©
      let avg = [0,0,0,0];
      let best = [null,null,null,null];
      for(let i=0;i<data.length;i++){
        let row = data[i];
        for(let j=0;j<4;j++){
          let v = parseFloat(row[COLUMNS[j+1].key]);
          if(!isNaN(v)) {
            avg[j] += v;
            if(best[j]===null) best[j]=v;
            else {
              if(j===0) best[j]=Math.min(best[j],v); // å®Œæˆæ—¶é—´å–æœ€å°
              else best[j]=Math.max(best[j],v); // å…¶å®ƒå–æœ€å¤§
            }
          }
        }
      }
      for(let j=0;j<4;j++) avg[j] = avg[j]/total;
      // è¿›æ­¥è¶‹åŠ¿ï¼ˆç®€å•çº¿æ€§å›å½’æ–œç‡ï¼‰
      function getTrend(vals) {
        let n=vals.length;
        if(n<2) return 0;
        let xsum=0,ysum=0,xysum=0,x2sum=0;
        for(let i=0;i<n;i++){ xsum+=i; ysum+=vals[i]; xysum+=i*vals[i]; x2sum+=i*i; }
        let slope = (n*xysum-xsum*ysum)/(n*x2sum-xsum*xsum);
        return slope;
      }
      let trends = [0,0,0,0];
      for(let j=0;j<4;j++) {
        let vals = data.map(row=>parseFloat(row[COLUMNS[j+1].key])).filter(v=>!isNaN(v));
        trends[j] = getTrend(vals);
      }
      // æ¸²æŸ“å¡ç‰‡
      let html = '<div class="stats-card" style="display:flex;gap:28px;flex-wrap:wrap;align-items:center;justify-content:center;margin:0 0 18px 0;">';
      html += '<div class="stats-item"><div class="stats-label">'+(L.totalTrain||'è®­ç»ƒæ¬¡æ•°')+'</div><div class="stats-value">'+total+'</div></div>';
      html += '<div class="stats-item"><div class="stats-label">'+(L.lastTrain||'æœ€è¿‘è®­ç»ƒ')+'</div><div class="stats-value">'+formatDate(new Date(lastTime))+'</div></div>';
      for(let j=0;j<4;j++) {
        let bestStr = j===0 ? secondsToTimeStr(best[j]) : (best[j]||'');
        let avgStr = j===0 ? secondsToTimeStr(avg[j]) : avg[j].toFixed(2);
        let trendStr = trends[j]===0 ? '' : (j===0 ? (trends[j]<0?'<span style="color:#43a047;">â†“</span>':'<span style="color:#e53935;">â†‘</span>') : (trends[j]>0?'<span style="color:#43a047;">â†‘</span>':'<span style="color:#e53935;">â†“</span>'));
        html += '<div class="stats-item"><div class="stats-label">'+L.labels[j+1]+'</div><div class="stats-value">'+bestStr+'<span class="stats-sub">(æœ€ä½³)</span></div><div class="stats-value" style="font-size:13px;color:#888;margin-top:2px;">'+avgStr+'<span class="stats-sub">(å‡å€¼)</span> '+trendStr+'</div></div>';
      }
      html += '</div>';
      statsDiv.innerHTML = html;
      statsDiv.style.display = '';
    }

    // ç»Ÿè®¡é¢æ¿æ ·å¼
    const statsPanelStyle = `
    .stats-card { background: #e3f2fd; border-radius: 14px; box-shadow: 0 2px 12px #2196f344; padding: 18px 24px; justify-content: center; }
    .night .stats-card { background: #23283a; box-shadow: 0 2px 12px #1565c044; }
    .stats-item { min-width: 120px; margin-right: 8px; }
    .stats-label { font-size: 14px; color: #1565c0; font-weight: 600; margin-bottom: 2px; }
    .night .stats-label { color: #90caf9; }
    .stats-value { font-size: 18px; font-weight: bold; color: #1976d2; }
    .night .stats-value { color: #90caf9; }
    .stats-sub { font-size: 12px; color: #888; margin-left: 2px; }
    @media (max-width: 600px) { .stats-card { flex-direction: column; gap: 10px; padding: 12px 6px; align-items: center; } .stats-item { min-width: 90px; } }
    `;
    if (!document.getElementById('statsPanelStyle')) {
      let style = document.createElement('style');
      style.id = 'statsPanelStyle';
      style.innerHTML = statsPanelStyle;
      document.head.appendChild(style);
    }

    // æ‚¬åœæ˜¾ç¤ºæ ‡ç­¾
    let tooltipTimer = null;
    document.getElementById('tableBody').addEventListener('mouseover', function(e) {
      if (e.target.tagName==='TD' && e.target.dataset.tooltip) {
        tooltipTimer = setTimeout(()=>{ e.target.classList.add('show-tooltip'); }, 1000);
      }
    });
    document.getElementById('tableBody').addEventListener('mouseout', function(e) {
      if (e.target.tagName==='TD' && e.target.dataset.tooltip) {
        clearTimeout(tooltipTimer); e.target.classList.remove('show-tooltip');
      }
    });

    // æ„è§åé¦ˆ
    document.getElementById('feedbackBtn').onclick = function() {
      alert(LANGS[lang].feedbackMsg);
    };

    // åˆ é™¤è®­ç»ƒé¡¹ç›®
    document.getElementById('deleteTableBtn').onclick = function() {
      if (!currentTable) return alert(LANGS[lang].pleaseSelectTable);
      if (!confirm(LANGS[lang].confirmDeleteTable)) return;
      delete tables[currentTable];
      saveTables(tables);
      refreshTableSelects();
      renderTable();
    };

    // ä¿®æ”¹æ•°æ®
    window.editData = function(idx) {
      if (!currentTable) return alert(LANGS[lang].pleaseSelectTable);
      let row = tables[currentTable][idx];
      let L = LANGS[lang];
      let html = '<div id="editModal" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:#0008;z-index:2000;display:flex;align-items:center;justify-content:center;">'+
        '<div style="background:#fff;padding:28px 24px;border-radius:10px;min-width:320px;max-width:90vw;box-shadow:0 2px 12px #2196f355;display:flex;flex-direction:column;gap:14px;">'+
        '<h3 style="margin:0 0 8px 0;color:#1565c0;">'+L.editTitle+'</h3>';
      for (let col of COLUMNS) {
        let v = row[col.key];
        if (col.key === 'trainTime') {
          let localVal = v ? formatDateLocal(new Date(v)) : formatDateLocal(new Date());
          html += '<label>'+col.label+'<input type="datetime-local" id="edit_'+col.key+'" style="margin-left:8px;" value="'+localVal+'"></label>';
        } else {
          html += '<label>'+col.label+'<input type="text" id="edit_'+col.key+'" style="margin-left:8px;" value="'+(v||'')+'"></label>';
        }
      }
      html += '<div style="display:flex;gap:16px;justify-content:center;margin-top:10px;">'+
        '<button id="editSaveBtn" style="background:#2196f3;color:#fff;padding:6px 18px;border:none;border-radius:6px;font-size:15px;">'+L.editSave+'</button>'+ 
        '<button id="editCancelBtn" style="background:#eee;color:#333;padding:6px 18px;border:none;border-radius:6px;font-size:15px;">'+L.editCancel+'</button>'+ 
        '</div></div></div>';
      document.body.insertAdjacentHTML('beforeend', html);
      document.getElementById('editCancelBtn').onclick = function() {
        document.getElementById('editModal').remove();
      };
      document.getElementById('editSaveBtn').onclick = function() {
        for (let col of COLUMNS) {
          let v = document.getElementById('edit_'+col.key).value;
          if (col.key === 'trainTime') {
            row[col.key] = v ? new Date(v).toISOString() : new Date().toISOString();
          } else {
            row[col.key] = v;
          }
        }
        tables[currentTable][idx] = JSON.parse(JSON.stringify(row));
        saveTables(tables);
        renderTable();
        document.getElementById('editModal').remove();
      };
    };

    // è‡ªåŠ¨ä¿å­˜æç¤º
    let saveTipTimer = null;
    function showSaveTip() {
      let tip = document.getElementById('saveTip');
      if (!tip) {
        tip = document.createElement('div');
        tip.id = 'saveTip';
        tip.style.position = 'fixed';
        tip.style.bottom = '32px';
        tip.style.left = '32px';
        tip.style.background = '#2196f3';
        tip.style.color = '#fff';
        tip.style.padding = '10px 22px';
        tip.style.borderRadius = '8px';
        tip.style.fontSize = '16px';
        tip.style.boxShadow = '0 2px 8px #2196f355';
        tip.style.zIndex = 3000;
        tip.style.opacity = 0;
        tip.style.transition = 'opacity 0.3s';
        document.body.appendChild(tip);
      }
      tip.textContent = LANGS[lang].saveTip || 'å·²ä¿å­˜';
      tip.style.opacity = 1;
      clearTimeout(saveTipTimer);
      saveTipTimer = setTimeout(()=>{ tip.style.opacity = 0; }, 1800);
    }

    // å¤‡ä»½æ•°æ®ï¼ˆå¯¼å‡ºJSONï¼‰
    document.getElementById('backupBtn').onclick = function() {
      const data = localStorage.getItem('aimbotz_local_data_tables') || '{}';
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'aimbotz_backup_'+(new Date().toISOString().slice(0,10))+'.json';
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
    };
    // æ¢å¤æ•°æ®ï¼ˆå¯¼å…¥JSONï¼‰
    document.getElementById('restoreBtn').onclick = function() {
      let input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json,application/json';
      input.onchange = function(e) {
        let file = e.target.files[0];
        if (!file) return;
        let reader = new FileReader();
        reader.onload = function(ev) {
          try {
            let obj = JSON.parse(ev.target.result);
            if (typeof obj !== 'object' || Array.isArray(obj)) throw 0;
            // å®¡æŸ¥æœºåˆ¶ï¼šå…¨è¡¨å»é‡
            let oldTables = loadTables();
            let merged = {};
            for (let key in obj) {
              let arr = obj[key] || [];
              let exist = (oldTables[key]||[]).map(row=>JSON.stringify(row));
              merged[key] = (oldTables[key]||[]).concat(arr.filter(row=>!exist.includes(JSON.stringify(row))));
            }
            tables = merged;
            saveTables(tables);
            refreshTableSelects();
            renderTable();
            renderStatsPanel();
            showSaveTip();
            alert((LANGS[lang].restoreSuccess)||'æ¢å¤æˆåŠŸï¼');
          } catch {
            alert((LANGS[lang].restoreFail)||'æ¢å¤å¤±è´¥ï¼Œæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼');
          }
        };
        reader.readAsText(file);
      };
      input.click();
    };

    // ä¸»é¢˜åˆ‡æ¢
    const THEME_KEY = 'aimbotz_theme';
    let theme = localStorage.getItem(THEME_KEY) || 'light';
    function setTheme(t) {
      theme = t;
      localStorage.setItem(THEME_KEY, t);
      if (t === 'night') document.body.classList.add('night');
      else document.body.classList.remove('night');
      renderThemeBtn();
    }
    function renderThemeBtn() {
      const btn = document.getElementById('themeToggleBtn');
      btn.textContent = (lang==='zh') ? (theme==='night'?'æ—¥é—´æ¨¡å¼':'å¤œé—´æ¨¡å¼') : (theme==='night'?'Day Mode':'Night Mode');
    }
    document.getElementById('themeToggleBtn').onclick = function() {
      setTheme(theme==='night'?'light':'night');
    };
    // è¯­è¨€åˆ‡æ¢æ—¶åŒæ­¥ä¸»é¢˜æŒ‰é’®æ–‡å­—
    const _setLang = setLang;
    setLang = function(l) {
      _setLang(l);
      renderThemeBtn();
    };
    // é¡µé¢åŠ è½½æ—¶åº”ç”¨ä¸»é¢˜
    setTheme(theme);

    // æ’åºå‡½æ•°
    window.sortTable = function(key) {
      if (sortCol===key) sortDir = (sortDir==='asc'?'desc':'asc');
      else { sortCol=key; sortDir='asc'; }
      renderTable();
    }

    // å¯¼å‡º/å¯¼å…¥èœå•å¼¹çª—
    function showMenuDialog(type) {
      let L = LANGS[lang];
      let html = '<div id="menuDialog" style="position:fixed;z-index:3002;top:0;left:0;width:100vw;height:100vh;display:flex;align-items:center;justify-content:center;background:#0005;">';
      html += '<div class="menu-dialog-box" style="background:'+(theme==='night'?'#23283a':'#fff')+';color:'+(theme==='night'?'#e3e6ef':'#222')+';padding:32px 28px 24px 28px;border-radius:16px;min-width:220px;max-width:96vw;box-shadow:0 4px 24px #2196f355;display:flex;flex-direction:column;gap:18px;align-items:center;">';
      html += '<h3 style="margin:0 0 12px 0;font-size:20px;color:#1565c0;letter-spacing:1px;">'+(type==='export'?L.export:L.import)+'</h3>';
      if(type==='export') {
        html += '<button id="exportExcelBtn" class="blue-btn" style="width:160px;margin-bottom:8px;">'+(L.exportExcel||'å¯¼å‡ºExcel')+'</button>';
        html += '<button id="exportJsonBtn" class="blue-btn" style="width:160px;">'+(L.exportJson||'å¯¼å‡ºJSONå¤‡ä»½')+'</button>';
      } else {
        html += '<button id="importExcelBtn" class="blue-btn" style="width:160px;margin-bottom:8px;">'+(L.importExcel||'å¯¼å…¥Excel')+'</button>';
        html += '<button id="importJsonBtn" class="blue-btn" style="width:160px;">'+(L.importJson||'å¯¼å…¥JSONå¤‡ä»½')+'</button>';
      }
      html += '<button id="menuDialogCancel" class="red-btn" style="width:160px;margin-top:16px;">'+(L.cancel||'å–æ¶ˆ')+'</button>';
      html += '</div></div>';
      document.body.insertAdjacentHTML('beforeend', html);
      document.getElementById('menuDialogCancel').onclick = function(){ document.getElementById('menuDialog').remove(); };
      if(type==='export') {
        document.getElementById('exportExcelBtn').onclick = function(){ document.getElementById('menuDialog').remove(); document.getElementById('exportCurrentBtn').click(); };
        document.getElementById('exportJsonBtn').onclick = function(){ document.getElementById('menuDialog').remove(); document.getElementById('backupBtn').click(); };
      } else {
        document.getElementById('importExcelBtn').onclick = function(){ document.getElementById('menuDialog').remove(); document.getElementById('importBtn').click(); };
        document.getElementById('importJsonBtn').onclick = function(){ document.getElementById('menuDialog').remove(); document.getElementById('restoreBtn').click(); };
      }
      document.getElementById('menuDialog').onclick = function(e){ if(e.target===this) this.remove(); };
    }
    document.getElementById('exportMenuBtn').onclick = function(){ showMenuDialog('export'); };
    document.getElementById('importMenuBtn').onclick = function(){ showMenuDialog('import'); };

    // æ‚¬æµ®è·³è½¬æŒ‰é’®é€»è¾‘
    document.getElementById('gotoTableBtn').onclick = function() {
      window.scrollTo({top:0, left:0, behavior:'smooth'});
    };
    document.getElementById('gotoChartsBtn').onclick = function() {
      const charts = document.querySelector('.charts');
      if(charts) charts.scrollIntoView({behavior:'smooth', block:'center'});
    };

    // åˆå§‹åŒ–æ¸²æŸ“
    refreshTableSelects();
    renderTable();
    renderStatsPanel();
    renderLang();
  </script>
</body>
</html> 